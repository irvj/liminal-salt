{% extends 'base.html' %}
{% load markdown_extras %}

{% block body_attrs %} style="display: flex; height: 100vh;"{% endblock %}

{% block body %}
<!-- Delete Confirmation Modal (Alpine.js + HTMX) -->
<div x-data="deleteModal" x-cloak>
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-modal"
         @click.self="showModal = false">
        <div class="bg-surface-secondary rounded-lg p-6 max-w-modal w-[90%] border border-border">
            <h3 class="text-foreground mb-3">Delete Chat?</h3>
            <p class="text-foreground-secondary mb-5">Are you sure you want to delete "<span x-text="sessionTitle"></span>"? This cannot be undone.</p>
            <form hx-post="{% url 'delete_chat' %}"
                  hx-target="#main-content"
                  hx-swap="innerHTML"
                  @htmx:after-request="showModal = false">
                {% csrf_token %}
                <input type="hidden" name="session_id" x-bind:value="sessionId">
                <div class="flex gap-3 justify-end">
                    <button type="button" @click="showModal = false" class="px-4 py-2 bg-border text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-danger text-foreground-on-accent rounded font-medium cursor-pointer hover:bg-danger-hover">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rename Chat Modal (Alpine.js + HTMX) -->
<div x-data="renameModal" x-cloak>
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-modal"
         @click.self="showModal = false">
        <div class="bg-surface-secondary rounded-lg p-6 max-w-modal w-[90%] border border-border">
            <h3 class="text-foreground mb-3">Rename Chat</h3>
            <input type="text"
                   x-model="newTitle"
                   maxlength="50"
                   @keydown.enter.prevent="$refs.renameForm.requestSubmit()"
                   class="w-full p-2.5 border border-border rounded bg-surface text-foreground text-sm mb-2 focus:outline-none focus:border-accent-cyan"
                   placeholder="Enter new title...">
            <p class="text-foreground-secondary text-xs mb-5">50 character limit</p>
            <form x-ref="renameForm"
                  hx-post="{% url 'rename_chat' %}"
                  hx-target="#sidebar-sessions"
                  hx-swap="innerHTML"
                  @htmx:after-request="showModal = false; updateHeaderTitle(newTitle)">
                {% csrf_token %}
                <input type="hidden" name="session_id" x-bind:value="sessionId">
                <input type="hidden" name="new_title" x-bind:value="newTitle">
                <div class="flex gap-3 justify-end">
                    <button type="button" @click="showModal = false" class="px-4 py-2 bg-border text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-accent text-foreground-on-accent rounded font-medium cursor-pointer hover:bg-accent-hover">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Wipe Memory Confirmation Modal (Alpine.js) -->
<div x-data="wipeMemoryModal" x-cloak data-wipe-url="{% url 'wipe_memory' %}">
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-modal"
         @click.self="showModal = false">
        <div class="bg-surface-secondary rounded-lg p-6 max-w-modal w-[90%] border border-border">
            <h3 class="text-foreground mb-3">Wipe Memory?</h3>
            <p class="text-foreground-secondary mb-5">Are you sure you want to wipe your entire long-term memory? This action cannot be undone.</p>
            <div class="flex gap-3 justify-end">
                <button @click="showModal = false" class="px-4 py-2 bg-border text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent">Cancel</button>
                <button @click="confirmWipe()" class="px-4 py-2 bg-danger text-foreground-on-accent rounded font-medium cursor-pointer hover:bg-danger-hover">Wipe</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit/New Persona Modal (Alpine.js) -->
<div x-data="editPersonaModal" x-cloak data-create-url="{% url 'create_persona' %}" data-save-url="{% url 'save_persona_file' %}">
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-modal"
         @click.self="showModal = false">
        <div class="bg-surface-secondary rounded-lg p-6 max-w-modal-xl w-[90%] border border-border">
            <h3 class="text-foreground mb-3" x-text="isNew ? 'New Persona' : 'Edit Persona'"></h3>
            <div class="mb-4">
                <label for="persona-name" class="block mb-2 font-medium text-foreground-secondary">Display Name:</label>
                <input type="text" id="persona-name" x-model="displayName"
                       :disabled="isAssistant"
                       :class="isAssistant ? 'opacity-50 cursor-not-allowed' : ''"
                       class="w-full p-2.5 border border-border rounded bg-surface text-foreground text-sm focus:outline-none focus:border-accent-cyan"
                       @input="displayName = displayName.replace(/[^a-zA-Z0-9 ]/g, '')">
                <p x-show="isAssistant" class="text-foreground-secondary text-xs mt-1">The default persona cannot be renamed.</p>
            </div>
            <label class="block mb-2 font-medium text-foreground-secondary">Persona File:</label>
            <textarea x-model="content" class="w-full h-[400px] bg-surface border border-border rounded text-foreground font-mono text-sm p-3 resize-y mb-4 focus:outline-none focus:border-accent-cyan"></textarea>
            <div class="flex gap-3 justify-end">
                <button @click="showModal = false" class="px-4 py-2 bg-border text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent">Cancel</button>
                <button @click="savePersona()" class="px-4 py-2 bg-success text-foreground-on-accent rounded font-medium cursor-pointer hover:bg-success/80">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Persona Modal (Alpine.js) -->
<div x-data="deletePersonaModal" x-cloak data-delete-url="{% url 'delete_persona' %}">
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-modal"
         @click.self="showModal = false">
        <div class="bg-surface-secondary rounded-lg p-6 max-w-modal w-[90%] border border-border">
            <h3 class="text-foreground mb-3">Delete Persona?</h3>
            <p class="text-foreground-secondary mb-5">Are you sure you want to delete "<span x-text="displayName"></span>"? This cannot be undone.</p>
            <div class="flex gap-3 justify-end">
                <button @click="showModal = false" class="px-4 py-2 bg-border text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent">Cancel</button>
                <button @click="confirmDelete()" class="px-4 py-2 bg-danger text-foreground-on-accent rounded font-medium cursor-pointer hover:bg-danger-hover">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Persona Model Modal (Alpine.js) -->
<div x-data="editPersonaModelModal" x-cloak data-models-url="{% url 'get_available_models' %}" data-save-url="{% url 'save_persona_model' %}">
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-modal"
         @click.self="showModal = false">
        <div class="bg-surface-secondary rounded-lg p-6 max-w-[500px] w-[90%] border border-border">
            <h3 class="text-foreground mb-2">Edit Model for <span class="text-accent-cyan" x-text="displayName"></span></h3>
            <p class="text-foreground-secondary text-sm mb-4">Select a model for this persona, or clear to use the default.</p>

            <!-- Status Messages -->
            <div x-show="statusMessage" x-transition
                 :class="statusType === 'success' ? 'bg-success text-surface' : 'bg-danger text-white'"
                 class="p-2 px-3 rounded mb-4 text-sm">
                <span x-text="statusMessage"></span>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="text-center py-4 text-foreground-secondary">
                Loading models...
            </div>

            <!-- Error State -->
            <div x-show="loadError && !loading" class="p-3 px-4 rounded mb-4 bg-danger text-white text-sm">
                <span x-text="loadError"></span>
                <button @click="loadModels()" class="ml-2 underline">Retry</button>
            </div>

            <!-- Model Picker -->
            <div class="mb-4" x-show="!loading && !loadError">
                <label class="block mb-2 font-medium text-foreground-secondary">Model:</label>
                <div class="relative">
                    <input type="text"
                           x-model="modelSearch"
                           @input="highlightedIndex = 0"
                           @focus="modelOpen = true"
                           @click.stop="modelOpen = true"
                           @keydown.escape="modelOpen = false"
                           @keydown.enter.prevent="selectHighlighted()"
                           @keydown.arrow-down.prevent="highlightNext()"
                           @keydown.arrow-up.prevent="highlightPrev()"
                           placeholder="Search models..."
                           :class="selectedModel ? 'border-accent-cyan bg-surface' : 'border-border bg-surface-secondary'"
                           class="w-full p-3 border rounded text-foreground text-base focus:outline-none focus:border-accent-cyan">

                    <div x-cloak
                         x-show="modelOpen && filteredModels.length > 0"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:leave="transition ease-in duration-75"
                         @click.away="modelOpen = false"
                         class="absolute w-full mt-1 max-h-64 overflow-y-auto bg-surface-secondary border border-border rounded-lg shadow-lg z-modal-nested">
                        <template x-for="(m, index) in filteredModels" :key="m.id">
                            <button type="button"
                                    @click="selectModel(m)"
                                    @mouseenter="highlightedIndex = index"
                                    :class="index === highlightedIndex ? 'bg-accent text-foreground-on-accent' : 'text-foreground hover:bg-surface-elevated'"
                                    class="block w-full px-4 py-2 text-left text-sm cursor-pointer">
                                <span x-text="m.display"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Current Model Display -->
            <div class="text-sm text-foreground-secondary mb-4">
                <strong>Current:</strong>
                <span x-text="currentModel || 'Using default (' + defaultModel + ')'"></span>
            </div>

            <div class="flex gap-3 justify-end">
                <button @click="clearModel()" class="px-4 py-2 bg-border text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent">Use Default</button>
                <button @click="showModal = false" class="px-4 py-2 bg-border text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent">Cancel</button>
                <button @click="saveModel()" :disabled="saving" class="px-4 py-2 bg-accent text-foreground-on-accent rounded font-medium cursor-pointer hover:bg-accent-hover disabled:opacity-50">
                    <span x-show="!saving">Save</span>
                    <span x-show="saving">...</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Context Files Modal (Alpine.js) -->
<div x-data="contextFilesModal" x-cloak>
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-modal"
         @click.self="showModal = false">
        <div class="bg-surface-secondary rounded-lg p-6 max-w-[500px] w-[90%] border border-border">
            <h2 class="text-foreground mb-2">Context Files</h2>
            <p class="text-foreground-secondary text-sm mb-5">Upload files to provide additional context to the assistant. These are included in every conversation but not used for memory generation.</p>

            <!-- Drop Zone -->
            <div class="border-2 border-dashed border-border rounded-lg p-10 text-center cursor-pointer transition-all mb-5 hover:border-accent hover:bg-accent/10"
                 :class="{ 'border-accent-cyan bg-accent-cyan/15': isDragging }"
                 @dragover.prevent="isDragging = true"
                 @dragleave.prevent="isDragging = false"
                 @drop.prevent="handleDrop($event)"
                 @click="$refs.fileInput.click()">
                <div class="pointer-events-none">
                    <div class="mb-3">{% include 'icons/folder.html' with class='w-12 h-12 mx-auto' %}</div>
                    <p class="text-foreground my-2" x-show="!isDragging">Drag & drop files here, or click to browse</p>
                    <p class="text-foreground my-2" x-show="isDragging">Drop files to upload</p>
                    <p class="text-xs text-foreground-secondary">Accepts .md and .txt files</p>
                </div>
                <input type="file"
                       x-ref="fileInput"
                       @change="handleFileSelect($event)"
                       accept=".md,.txt"
                       multiple
                       class="hidden">
            </div>

            <!-- Upload Status -->
            <div x-show="uploadStatus" x-transition class="p-2 px-3 rounded mb-4 text-sm" :class="uploadStatusType === 'success' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'">
                <span x-text="uploadStatus"></span>
            </div>

            <!-- File List -->
            <div class="max-h-[200px] overflow-y-auto mb-5">
                <template x-for="file in files" :key="file.name">
                    <div class="flex items-center gap-3 py-2.5 border-b border-surface last:border-b-0">
                        <label class="relative w-11 h-6 shrink-0">
                            <input type="checkbox" :checked="file.enabled" @change="toggleFile(file.name)" class="opacity-0 w-0 h-0 peer">
                            <span class="absolute cursor-pointer inset-0 bg-surface-elevated rounded-full transition-colors peer-checked:bg-accent before:absolute before:content-[''] before:h-[18px] before:w-[18px] before:left-[3px] before:bottom-[3px] before:bg-foreground-secondary before:rounded-full before:transition-transform peer-checked:before:translate-x-5"></span>
                        </label>
                        <span class="flex-1 text-foreground cursor-pointer hover:text-accent-cyan" x-text="file.name" @click="openEditFile(file.name)"></span>
                        <button class="bg-transparent border-none text-danger cursor-pointer px-1 py-1 hover:text-warning" @click="deleteFile(file.name)">{% include 'icons/x.html' with class='w-5 h-5' %}</button>
                    </div>
                </template>
                <p x-show="files.length === 0" class="text-border italic text-center py-5">No context files uploaded.</p>
            </div>

            <!-- Close Button -->
            <div class="flex justify-end gap-3">
                <button @click="showModal = false" class="px-6 py-2.5 bg-accent text-foreground-on-accent rounded font-medium hover:bg-accent-hover">Done</button>
            </div>
        </div>
    </div>

    <!-- File Edit Modal (nested) -->
    <div x-show="editModal.show"
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-modal-nested"
         @click.self="editModal.show = false">
        <div class="bg-surface-secondary rounded-lg p-6 max-w-modal-lg w-[90%] border border-border">
            <h2 class="text-foreground mb-2">Edit File</h2>
            <p class="text-accent-cyan font-mono mb-4" x-text="editModal.filename"></p>
            <textarea x-model="editModal.content"
                      class="w-full h-[300px] bg-surface border border-border rounded text-foreground font-mono text-sm p-3 resize-y mb-4 focus:outline-none focus:border-accent-cyan"
                      placeholder="File content..."></textarea>
            <div x-show="editModal.status" class="p-2 px-3 rounded mb-4 text-sm" :class="editModal.statusType === 'success' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'">
                <span x-text="editModal.status"></span>
            </div>
            <div class="flex justify-end gap-3">
                <button @click="editModal.show = false" class="px-6 py-2.5 bg-border text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent">Cancel</button>
                <button @click="saveEditFile()" class="px-6 py-2.5 bg-accent text-foreground-on-accent rounded font-medium hover:bg-accent-hover">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar wrapper with mobile state (contents = invisible to flex layout) -->
<div class="contents" x-data="sidebarState">

    <!-- Mobile backdrop -->
    <div x-show="isMobile && !collapsed"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="collapsed = true"
         class="fixed inset-0 bg-black/50 z-sidebar-backdrop">
    </div>

    <!-- Sidebar -->
    <aside :class="{
               'w-sidebar-collapsed': collapsed,
               'w-sidebar': !collapsed,
               'fixed inset-y-0 left-0 z-sidebar': isMobile && !collapsed
           }"
           class="h-full flex flex-col bg-surface-secondary border-r border-border transition-all duration-200">

        <!-- Header with toggle (always visible) -->
        <div class="p-5 pb-0">
            <div class="flex items-center mb-4" :class="collapsed ? 'justify-center' : 'justify-between'">
                <h2 x-show="!collapsed" class="text-accent-cyan text-xl">Liminal Salt</h2>
                <button @click="collapsed = !collapsed"
                        class="text-foreground-secondary hover:text-foreground cursor-pointer text-xl"
                        :title="collapsed ? 'Expand sidebar' : 'Collapse sidebar'">
                    <span x-show="collapsed">{% include 'icons/menu.html' with class='w-6 h-6' %}</span>
                    <span x-show="!collapsed">{% include 'icons/chevrons-left.html' with class='w-6 h-6' %}</span>
                </button>
            </div>
        </div>

        <!-- Scrollable content (hidden when collapsed) -->
        <div x-show="!collapsed" x-transition class="flex-1 overflow-y-auto px-5">
            <div id="new-chat-button">
            {% include "chat/new_chat_button.html" %}
            </div>

            <!-- Sessions grouped by persona -->
            <div id="sidebar-sessions">
            {% include "chat/sidebar_sessions.html" %}
            </div>
        </div>

        <!-- Footer (always visible) -->
        <div class="p-3 border-t border-border">
            <div class="flex justify-center gap-4" :class="collapsed ? 'flex-col items-center' : ''">
                <!-- New Chat -->
                <button hx-get="{% url 'new_chat' %}"
                        hx-target="#main-content"
                        hx-swap="innerHTML"
                        @click="saveDraftNow(); if (isMobile) collapsed = true"
                        class="p-2 text-foreground-secondary hover:text-foreground rounded hover:bg-surface-elevated transition-colors cursor-pointer"
                        title="New Chat">
                    {% include 'icons/circle-plus.html' with class='w-6 h-6' %}
                </button>
                <!-- Memory -->
                <button hx-get="{% url 'memory' %}"
                        hx-target="#main-content"
                        hx-swap="innerHTML"
                        @click="saveDraftNow(); if (isMobile) collapsed = true"
                        class="p-2 text-foreground-secondary hover:text-foreground rounded hover:bg-surface-elevated transition-colors cursor-pointer"
                        title="User Memory">
                    {% include 'icons/brain-cog.html' with class='w-6 h-6' %}
                </button>
                <!-- Persona -->
                <button hx-get="{% url 'persona_settings' %}"
                        hx-target="#main-content"
                        hx-swap="innerHTML"
                        @click="saveDraftNow(); if (isMobile) collapsed = true"
                        class="p-2 text-foreground-secondary hover:text-foreground rounded hover:bg-surface-elevated transition-colors cursor-pointer"
                        title="Persona Settings">
                    {% include 'icons/user-pen.html' with class='w-6 h-6' %}
                </button>
                <!-- Settings -->
                <button hx-get="{% url 'settings' %}"
                        hx-target="#main-content"
                        hx-swap="innerHTML"
                        @click="saveDraftNow(); if (isMobile) collapsed = true"
                        class="p-2 text-foreground-secondary hover:text-foreground rounded hover:bg-surface-elevated transition-colors cursor-pointer"
                        title="Settings">
                    {% include 'icons/settings.html' with class='w-6 h-6' %}
                </button>
                <!-- Theme Toggle -->
                <button @click="toggleTheme()"
                        class="p-2 text-xl text-foreground-secondary hover:text-foreground rounded hover:bg-surface-elevated transition-colors cursor-pointer"
                        :title="isDark ? 'Switch to light mode' : 'Switch to dark mode'">
                    <span x-show="isDark">{% include 'icons/moon.html' with class='w-6 h-6' %}</span>
                    <span x-show="!isDark">{% include 'icons/sun.html' with class='w-6 h-6' %}</span>
                </button>
            </div>
        </div>
    </aside>
</div>

<!-- Main Chat Area -->
<div class="flex-1 flex flex-col" id="main-content">
    {% if show_home %}
        {% include 'chat/chat_home.html' %}
    {% else %}
        {% include 'chat/chat_main.html' %}
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Auto-scroll to bottom on page load
    const messagesDiv = document.getElementById('messages');
    if (messagesDiv) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Setup scroll button listener on page load and after HTMX swaps
    setupScrollButtonListener();
    document.body.addEventListener('htmx:afterSwap', setupScrollButtonListener);

    // Listen for HTMX responses to update title when it changes
    document.body.addEventListener('htmx:afterRequest', function(event) {
        // Re-set timezone input after HTMX swaps (input may have been replaced)
        setTimezoneInput();

        const xhr = event.detail.xhr;
        if (!xhr) return;

        const newTitle = xhr.getResponseHeader('X-Chat-Title');
        const sessionId = xhr.getResponseHeader('X-Chat-Session-Id');

        if (newTitle && sessionId) {
            // Update sidebar item
            const sidebarItem = document.querySelector(`.session-row[data-session-id="${sessionId}"] .session-item`);
            if (sidebarItem) {
                sidebarItem.textContent = newTitle;
            }

            // Update header title
            updateHeaderTitle(newTitle);
        }

        // Convert timestamps and add date separators after HTMX swap
        convertTimestamps();
        insertDateSeparators();
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        setTimezoneInput();
        convertTimestamps();
        insertDateSeparators();
    });
</script>
{% endblock %}
