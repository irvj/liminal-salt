{% extends 'base.html' %}
{% load markdown_extras %}

{% block title %}{{ title }} - Liminal Salt{% endblock %}

{% block body_style %}display: flex; height: 100vh;{% endblock %}

{% block extra_styles %}
.sidebar {
    width: 300px;
    background: #3B4252;
    padding: 20px;
    overflow-y: auto;
    border-right: 1px solid #4C566A;
}
.sidebar h2 {
    color: #88C0D0;
    margin-bottom: 16px;
    font-size: 20px;
}
.sidebar button, .sidebar a {
    display: block;
    width: 100%;
    padding: 10px;
    margin: 4px 0;
    background: #4C566A;
    color: #ECEFF4;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
}
.sidebar button:hover, .sidebar a:hover {
    background: #5E81AC;
}
.sidebar .current {
    background: #5E81AC;
    font-weight: bold;
}
.sidebar .personality-header {
    background: #4C566A;
    color: #88C0D0;
    font-weight: 600;
    margin-top: 12px;
}
.sidebar .session-item {
    padding-left: 20px;
    font-size: 13px;
}
.sidebar .session-row {
    display: flex;
    align-items: stretch;
    margin: 4px 0;
    gap: 2px;
}
.sidebar .session-row .session-item {
    flex: 1;
    margin: 0;
    border-radius: 4px 0 0 4px;
}
.sidebar .session-row .delete-btn {
    width: 32px;
    padding: 0;
    margin: 0;
    background: #4C566A;
    border-radius: 0 4px 4px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    opacity: 0.6;
}
.sidebar .session-row .delete-btn:hover {
    background: #BF616A;
    opacity: 1;
}
/* Modal styles */
.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal {
    background: #3B4252;
    border-radius: 8px;
    padding: 24px;
    max-width: 400px;
    width: 90%;
    border: 1px solid #4C566A;
}
.modal h3 {
    color: #ECEFF4;
    margin-bottom: 12px;
}
.modal p {
    color: #D8DEE9;
    margin-bottom: 20px;
}
.modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}
.modal-buttons button {
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: 500;
    width: auto;
}
.modal-buttons .cancel-btn {
    background: #4C566A;
}
.modal-buttons .confirm-btn {
    background: #BF616A;
}
.modal .form-group {
    margin: 16px 0;
}
.modal .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #D8DEE9;
}
.modal-select {
    width: 100%;
    padding: 10px;
    border: 1px solid #4C566A;
    border-radius: 4px;
    background: #2E3440;
    color: #ECEFF4;
    font-size: 14px;
}
.modal-select:focus {
    outline: none;
    border-color: #88C0D0;
}

/* Context Files Modal */
.context-files-modal {
    max-width: 500px;
    width: 90%;
}
.context-files-modal h2 {
    color: #ECEFF4;
    margin-bottom: 8px;
}
.modal-help {
    color: #D8DEE9;
    font-size: 14px;
    margin-bottom: 20px;
}
.drop-zone {
    border: 2px dashed #4C566A;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: 20px;
}
.drop-zone:hover {
    border-color: #5E81AC;
    background: rgba(94, 129, 172, 0.1);
}
.drop-zone.drag-over {
    border-color: #88C0D0;
    background: rgba(136, 192, 208, 0.15);
}
.drop-zone-content {
    pointer-events: none;
}
.drop-icon {
    font-size: 48px;
    margin-bottom: 12px;
}
.drop-zone p {
    margin: 8px 0;
    color: #ECEFF4;
}
.drop-zone .file-types {
    font-size: 12px;
    color: #D8DEE9;
}
.upload-status {
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 16px;
    font-size: 14px;
}
.upload-status.success {
    background: rgba(163, 190, 140, 0.2);
    color: #A3BE8C;
}
.upload-status.error {
    background: rgba(191, 97, 106, 0.2);
    color: #BF616A;
}
.context-modal-file-list {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 20px;
}
.context-modal-file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid #3B4252;
}
.context-modal-file-item:last-child {
    border-bottom: none;
}
.context-modal-file-item .filename {
    flex: 1;
    color: #ECEFF4;
    cursor: pointer;
}
.context-modal-file-item .filename:hover {
    color: #88C0D0;
}
.context-modal-file-item .delete-btn {
    background: transparent;
    border: none;
    color: #BF616A;
    cursor: pointer;
    font-size: 18px;
    padding: 4px 8px;
}
.context-modal-file-item .delete-btn:hover {
    color: #D08770;
}

/* Custom Toggle Switch */
.toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
}
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #4C566A;
    transition: 0.2s;
    border-radius: 24px;
}
.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: #D8DEE9;
    transition: 0.2s;
    border-radius: 50%;
}
input:checked + .toggle-slider {
    background-color: #5E81AC;
}
input:checked + .toggle-slider:before {
    transform: translateX(20px);
}
.toggle-slider:hover {
    background-color: #434C5E;
}
input:checked + .toggle-slider:hover {
    background-color: #81A1C1;
}

/* File Edit Modal */
.file-edit-modal {
    max-width: 600px;
    width: 90%;
}
.modal-filename {
    color: #88C0D0;
    font-family: monospace;
    margin-bottom: 16px;
}
.file-edit-textarea {
    width: 100%;
    height: 300px;
    background: #2E3440;
    border: 1px solid #4C566A;
    border-radius: 4px;
    color: #ECEFF4;
    font-family: monospace;
    font-size: 14px;
    padding: 12px;
    resize: vertical;
    margin-bottom: 16px;
    box-sizing: border-box;
}
.file-edit-textarea:focus {
    outline: none;
    border-color: #88C0D0;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}
.modal-actions .button-secondary {
    padding: 10px 24px;
    background: #4C566A;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
}
.modal-actions .button-secondary:hover {
    background: #5E81AC;
}
.modal-actions .button-primary {
    padding: 10px 24px;
    background: #5E81AC;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
}
.modal-actions .button-primary:hover {
    background: #81A1C1;
}
.no-files {
    color: #4C566A;
    font-style: italic;
    text-align: center;
    padding: 20px 0;
}

/* Context Files Button */
.context-files-btn {
    position: relative;
}
.context-files-btn .badge {
    background: #5E81AC;
    color: white;
    border-radius: 10px;
    padding: 2px 8px;
    font-size: 12px;
    margin-left: 8px;
}

/* Hide Alpine elements until initialized */
[x-cloak] {
    display: none !important;
}
/* Memory page styles */
.memory-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}
.memory-buttons {
    display: flex;
    gap: 12px;
    margin: 20px 0;
}
.memory-buttons button, .memory-buttons .button-primary {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    font-weight: 500;
    background: #5E81AC;
    color: white;
}
.memory-buttons button:hover {
    background: #81A1C1;
}
.memory-buttons .button-danger {
    background: #4C566A;
}
.memory-buttons .button-danger:hover {
    background: #BF616A;
}
.memory-timestamp {
    font-size: 12px;
    color: #D8DEE9;
    margin-bottom: 16px;
}
.memory-content-box {
    background: #3B4252;
    padding: 20px;
    border-radius: 8px;
    line-height: 1.6;
    border-left: 4px solid #5E81AC;
}
.memory-content-box p {
    margin-bottom: 1em;
}
.memory-content-box p:last-child {
    margin-bottom: 0;
}
.memory-content-box .empty-state {
    text-align: center;
    color: #D8DEE9;
    padding: 40px 20px;
}
/* Context Files Section */
.context-files-section {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid #4C566A;
}
.context-files-section h3 {
    margin: 0 0 8px 0;
    color: #ECEFF4;
    font-size: 18px;
}
.context-files-section .help-text {
    color: #D8DEE9;
    font-size: 14px;
    margin-bottom: 16px;
}
.context-file-list {
    margin-bottom: 16px;
}
.context-file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    border-bottom: 1px solid #3B4252;
}
.context-file-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}
.context-file-item .filename {
    flex: 1;
    color: #ECEFF4;
}
.context-file-item .delete-btn {
    background: transparent;
    border: none;
    color: #BF616A;
    cursor: pointer;
    font-size: 18px;
    padding: 4px 8px;
}
.context-file-item .delete-btn:hover {
    color: #D08770;
}
.no-files {
    color: #4C566A;
    font-style: italic;
}
.upload-form {
    display: flex;
    gap: 12px;
    align-items: center;
}
.upload-form input[type="file"] {
    flex: 1;
    color: #ECEFF4;
}
.upload-form button {
    padding: 8px 16px;
    background: #5E81AC;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.upload-form button:hover {
    background: #81A1C1;
}
.alert {
    padding: 12px 16px;
    border-radius: 4px;
    margin-bottom: 16px;
}
.alert-success {
    background: #A3BE8C;
    color: #2E3440;
}
.alert-error {
    background: #BF616A;
    color: white;
}
#memory-status .updating-dots span {
    animation: blink 1.4s infinite;
}
#memory-status .updating-dots span:nth-child(2) {
    animation-delay: 0.2s;
}
#memory-status .updating-dots span:nth-child(3) {
    animation-delay: 0.4s;
}
/* Settings page styles */
.settings-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}
.settings-area h2 {
    color: #88C0D0;
    font-size: 18px;
    margin-bottom: 16px;
}
.settings-info {
    color: #D8DEE9;
    font-size: 14px;
    margin-bottom: 16px;
}
.settings-area .form-group {
    margin: 20px 0;
}
.settings-area label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
}
.settings-select {
    width: 100%;
    max-width: 400px;
    padding: 10px;
    border: 1px solid #4C566A;
    border-radius: 4px;
    background: #3B4252;
    color: #ECEFF4;
    font-size: 16px;
}
.settings-select:focus {
    outline: none;
    border-color: #88C0D0;
}
.settings-area .button-primary {
    padding: 12px 24px;
    background: #5E81AC;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    font-size: 16px;
}
.settings-area .button-primary:hover {
    background: #81A1C1;
}
.settings-preview {
    background: #3B4252;
    padding: 16px;
    border-radius: 8px;
    margin-top: 20px;
    font-size: 14px;
    border-left: 4px solid #5E81AC;
    line-height: 1.6;
}
.settings-preview p {
    margin-bottom: 1em;
}
.settings-preview p:last-child {
    margin-bottom: 0;
}
.settings-preview ul, .settings-preview ol {
    margin-left: 1.5em;
    margin-bottom: 1em;
}
.settings-preview li {
    margin-bottom: 0.25em;
}
.personality-editor {
    width: 100%;
    height: 400px;
    background: #2E3440;
    color: #ECEFF4;
    border: 1px solid #4C566A;
    border-radius: 4px;
    padding: 12px;
    font-family: monospace;
    font-size: 14px;
    resize: vertical;
    margin-bottom: 16px;
    box-sizing: border-box;
}
.personality-editor:focus {
    outline: none;
    border-color: #88C0D0;
}
.modal-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #4C566A;
    border-radius: 4px;
    background: #2E3440;
    color: #ECEFF4;
    font-size: 14px;
    margin-bottom: 8px;
    box-sizing: border-box;
}
.modal-input:focus {
    outline: none;
    border-color: #88C0D0;
}
.button-secondary {
    background: #4C566A;
    color: #ECEFF4;
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    font-weight: 500;
    margin-left: 8px;
}
.button-secondary:hover {
    background: #5E81AC;
}
.button-danger {
    background: #BF616A;
    color: #ECEFF4;
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    font-weight: 500;
    margin-left: 8px;
}
.button-danger:hover {
    background: #d08088;
}
.main {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.header {
    background: #3B4252;
    padding: 16px 20px;
    border-bottom: 1px solid #4C566A;
}
.header h1 {
    font-size: 24px;
    color: #88C0D0;
}
.header .subtitle {
    font-size: 12px;
    color: #D8DEE9;
    margin-top: 4px;
}
.messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}
.message {
    padding: 12px 16px;
    border-radius: 8px;
    width: fit-content;
}
.message.user {
    background: #5E81AC;
    position: relative;
}
.message.user::after {
    content: '';
    position: absolute;
    right: 4px;
    bottom: -10px;
    width: 16px;
    height: 12px;
    background: #5E81AC;
    border-radius: 0 6px 1px 16px;
}
.message.assistant {
    background: #4C566A;
    position: relative;
}
.message.assistant::after {
    content: '';
    position: absolute;
    left: 4px;
    bottom: -10px;
    width: 16px;
    height: 12px;
    background: #4C566A;
    border-radius: 6px 0 16px 1px;
}
.message.error {
    background: #BF616A;
}
.message pre {
    background: #2E3440;
    padding: 8px;
    border-radius: 4px;
    overflow-x: auto;
    margin-top: 8px;
}
.message p {
    margin-bottom: 1em;
}
.message p:last-child {
    margin-bottom: 0;
}
.message ul, .message ol {
    margin-left: 1.5em;
    margin-bottom: 1em;
}
.message li {
    margin-bottom: 0.25em;
}
.input-area {
    background: #3B4252;
    padding: 20px;
    border-top: 1px solid #4C566A;
}
.input-area form {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}
.input-area input,
.input-area textarea {
    flex: 1;
    padding: 12px;
    border: 1px solid #4C566A;
    border-radius: 4px;
    background: #2E3440;
    color: #ECEFF4;
    font-size: 16px;
    font-family: inherit;
}
.input-area textarea {
    resize: none;
    min-height: 24px;
    max-height: 200px;
    overflow-y: auto;
}
.input-area input:focus,
.input-area textarea:focus {
    outline: none;
    border-color: #88C0D0;
}
.input-area button {
    padding: 12px 24px;
    background: #5E81AC;
    color: white;
    border: 1px solid #5E81AC;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    font-size: 16px;
}
.input-area button:hover {
    background: #81A1C1;
}
.divider {
    height: 1px;
    background: #4C566A;
    margin: 12px 0;
}
.message.thinking {
    opacity: 0.7;
}
.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 4px 0;
}
.typing-indicator span {
    width: 8px;
    height: 8px;
    background: #D8DEE9;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
}
.typing-indicator span:nth-child(1) {
    animation-delay: 0s;
}
.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}
.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}
@keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-6px); opacity: 1; }
}
/* Staggered fade-in for assistant responses */
.fade-in-chunk {
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.9s ease, transform 0.9s ease;
}
.fade-in-chunk.visible {
    opacity: 1;
    transform: translateY(0);
}
/* Message container styles */
.message-container {
    margin: 16px 0;
    max-width: 80%;
    width: fit-content;
}
.message-container.user {
    margin-left: auto;
}
.message-container.assistant {
    margin-right: auto;
}
.message-container .message {
    margin: 0;
}
/* Timestamp styles */
.timestamp {
    display: block;
    font-size: 11px;
    color: #8a93a3;
    margin-top: 14px;
    padding: 0 4px;
}
.message-container.user .timestamp {
    text-align: right;
}
.message-container.assistant .timestamp {
    text-align: left;
}
/* Date separator styles */
.date-separator {
    text-align: center;
    color: #8a93a3;
    font-size: 12px;
    margin: 24px 0 16px 0;
    position: relative;
}
.date-separator::before,
.date-separator::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 30%;
    height: 1px;
    background: #4C566A;
}
.date-separator::before {
    left: 0;
}
.date-separator::after {
    right: 0;
}
{% endblock %}

{% block body %}
<!-- New Chat Modal (Alpine.js) -->
<div x-data="newChatModal()" x-cloak>
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="modal-backdrop"
         @click.self="showModal = false">
        <div class="modal">
            <h3>New Chat</h3>
            <p>Choose a personality for this conversation:</p>
            <form hx-post="{% url 'new_chat' %}" hx-swap="none">
                {% csrf_token %}
                <div class="form-group">
                    <label for="new-chat-personality">Personality:</label>
                    <select id="new-chat-personality" name="personality" class="modal-select">
                        {% for p in available_personalities %}
                            <option value="{{ p }}" {% if p == default_personality %}selected{% endif %}>
                                {{ p|display_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" @click="showModal = false" class="cancel-btn">Cancel</button>
                    <button type="submit" class="confirm-btn" style="background: #A3BE8C;">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal (Alpine.js + HTMX) -->
<div x-data="deleteModal()" x-cloak>
    <!-- Modal backdrop -->
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="modal-backdrop"
         @click.self="showModal = false">
        <div class="modal">
            <h3>Delete Chat?</h3>
            <p>Are you sure you want to delete "<span x-text="sessionTitle"></span>"? This cannot be undone.</p>
            <form hx-post="{% url 'delete_chat' %}"
                  hx-target="#main-content"
                  hx-swap="innerHTML"
                  @htmx:after-request="showModal = false">
                {% csrf_token %}
                <input type="hidden" name="session_id" x-bind:value="sessionId">
                <div class="modal-buttons">
                    <button type="button" @click="showModal = false" class="cancel-btn">Cancel</button>
                    <button type="submit" class="confirm-btn">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Wipe Memory Confirmation Modal (Alpine.js) -->
<div x-data="wipeMemoryModal()" x-cloak>
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="modal-backdrop"
         @click.self="showModal = false">
        <div class="modal">
            <h3>Wipe Memory?</h3>
            <p>Are you sure you want to wipe your entire long-term memory? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button @click="showModal = false" class="cancel-btn">Cancel</button>
                <button @click="confirmWipe()" class="confirm-btn">Wipe</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit/New Personality Modal (Alpine.js) -->
<div x-data="editPersonalityModal()" x-cloak>
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="modal-backdrop"
         @click.self="showModal = false">
        <div class="modal" style="max-width: 700px;">
            <h3 x-text="isNew ? 'New Personality' : 'Edit Personality'"></h3>
            <div class="form-group" style="margin-bottom: 16px;">
                <label for="personality-name" style="display: block; margin-bottom: 8px; font-weight: 500; color: #D8DEE9;">Display Name:</label>
                <input type="text" id="personality-name" x-model="displayName" class="modal-input" @input="displayName = displayName.replace(/[^a-zA-Z0-9 ]/g, '')">
            </div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #D8DEE9;">Personality File:</label>
            <textarea x-model="content" class="personality-editor"></textarea>
            <div class="modal-buttons">
                <button @click="showModal = false" class="cancel-btn">Cancel</button>
                <button @click="savePersonality()" class="confirm-btn" style="background: #A3BE8C;">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Personality Modal (Alpine.js) -->
<div x-data="deletePersonalityModal()" x-cloak>
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="modal-backdrop"
         @click.self="showModal = false">
        <div class="modal">
            <h3>Delete Personality?</h3>
            <p>Are you sure you want to delete "<span x-text="displayName"></span>"? This cannot be undone.</p>
            <div class="modal-buttons">
                <button @click="showModal = false" class="cancel-btn">Cancel</button>
                <button @click="confirmDelete()" class="confirm-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Context Files Modal (Alpine.js) -->
<div x-data="contextFilesModal()" x-cloak>
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="modal-backdrop"
         @click.self="showModal = false">
        <div class="modal context-files-modal">
            <h2>Context Files</h2>
            <p class="modal-help">Upload files to provide additional context to the assistant. These are included in every conversation but not used for memory generation.</p>

            <!-- Drop Zone -->
            <div class="drop-zone"
                 :class="{ 'drag-over': isDragging }"
                 @dragover.prevent="isDragging = true"
                 @dragleave.prevent="isDragging = false"
                 @drop.prevent="handleDrop($event)"
                 @click="$refs.fileInput.click()">
                <div class="drop-zone-content">
                    <div class="drop-icon">üìÅ</div>
                    <p x-show="!isDragging">Drag & drop files here, or click to browse</p>
                    <p x-show="isDragging">Drop files to upload</p>
                    <p class="file-types">Accepts .md and .txt files</p>
                </div>
                <input type="file"
                       x-ref="fileInput"
                       @change="handleFileSelect($event)"
                       accept=".md,.txt"
                       multiple
                       style="display: none;">
            </div>

            <!-- Upload Status -->
            <div x-show="uploadStatus" x-transition class="upload-status" :class="uploadStatusType">
                <span x-text="uploadStatus"></span>
            </div>

            <!-- File List -->
            <div class="context-modal-file-list">
                <template x-for="file in files" :key="file.name">
                    <div class="context-modal-file-item">
                        <label class="toggle-switch">
                            <input type="checkbox" :checked="file.enabled" @change="toggleFile(file.name)">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="filename" x-text="file.name" @click="openEditFile(file.name)"></span>
                        <button class="delete-btn" @click="deleteFile(file.name)">√ó</button>
                    </div>
                </template>
                <p x-show="files.length === 0" class="no-files">No context files uploaded.</p>
            </div>

            <!-- Close Button -->
            <div class="modal-actions">
                <button @click="showModal = false" class="button-primary">Done</button>
            </div>
        </div>
    </div>

    <!-- File Edit Modal (nested) -->
    <div x-show="editModal.show"
         class="modal-backdrop"
         @click.self="editModal.show = false"
         style="z-index: 1001;">
        <div class="modal file-edit-modal">
            <h2>Edit File</h2>
            <p class="modal-filename" x-text="editModal.filename"></p>
            <textarea x-model="editModal.content"
                      class="file-edit-textarea"
                      placeholder="File content..."></textarea>
            <div x-show="editModal.status" class="upload-status" :class="editModal.statusType">
                <span x-text="editModal.status"></span>
            </div>
            <div class="modal-actions">
                <button @click="editModal.show = false" class="button-secondary">Cancel</button>
                <button @click="saveEditFile()" class="button-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar -->
<aside class="sidebar">
    <h2>üßÇ Liminal Salt</h2>

    <div id="new-chat-button">
    {% include "chat/new_chat_button.html" %}
    </div>

    <div class="divider"></div>

    <!-- Sessions grouped by personality -->
    <div id="sidebar-sessions">
    {% include "chat/sidebar_sessions.html" %}
    </div>

    <div class="divider"></div>

    <button hx-get="{% url 'memory' %}"
            hx-target="#main-content"
            hx-swap="innerHTML"
            onclick="updateSidebarHighlight(this)"
            class="session-item">
        User Memory
    </button>
    <button hx-get="{% url 'settings' %}"
            hx-target="#main-content"
            hx-swap="innerHTML"
            onclick="updateSidebarHighlight(this)"
            class="session-item">
        Settings
    </button>
</aside>

<!-- Main Chat Area -->
<div class="main" id="main-content">
    {% include 'chat/chat_main.html' %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Auto-scroll to bottom on page load
    const messagesDiv = document.getElementById('messages');
    if (messagesDiv) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Add user message immediately and show thinking indicator
    function addUserMessage(event) {
        const input = document.getElementById('message-input');
        const message = input.value.trim();

        if (!message) return;

        // Clear input immediately (don't wait for response)
        input.value = '';

        // Create and append user message with container
        const messagesDiv = document.getElementById('messages');
        const now = new Date();

        // Check if we need a date separator for today
        const lastContainer = messagesDiv.querySelector('.message-container:last-of-type');
        let needsSeparator = true;

        if (lastContainer) {
            const lastTimestamp = lastContainer.querySelector('.timestamp[data-utc]');
            if (lastTimestamp) {
                const lastDate = new Date(lastTimestamp.getAttribute('data-utc'));
                if (lastDate.toDateString() === now.toDateString()) {
                    needsSeparator = false;
                }
            }
        } else {
            // No messages yet, check if there's already a separator
            const existingSeparator = messagesDiv.querySelector('.date-separator');
            if (existingSeparator) needsSeparator = false;
        }

        if (needsSeparator) {
            const separator = document.createElement('div');
            separator.className = 'date-separator';
            separator.textContent = formatDateSeparator(now);
            messagesDiv.appendChild(separator);
        }

        const container = document.createElement('div');
        container.className = 'message-container user';

        const userDiv = document.createElement('div');
        userDiv.className = 'message user';
        userDiv.textContent = message;
        container.appendChild(userDiv);

        // Add timestamp outside the bubble
        const timestamp = document.createElement('span');
        timestamp.className = 'timestamp';
        timestamp.setAttribute('data-utc', now.toISOString());
        timestamp.textContent = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        container.appendChild(timestamp);

        messagesDiv.appendChild(container);

        // Create and append thinking indicator
        const thinkingDiv = document.createElement('div');
        thinkingDiv.id = 'thinking-indicator';
        thinkingDiv.className = 'message assistant thinking';
        thinkingDiv.innerHTML = '<span class="typing-indicator"><span></span><span></span><span></span></span>';
        messagesDiv.appendChild(thinkingDiv);

        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Remove thinking indicator after response arrives
    function removeThinkingIndicator() {
        const thinking = document.getElementById('thinking-indicator');
        if (thinking) {
            thinking.remove();
        }
    }

    // Scroll to bottom helper
    function scrollToBottom() {
        const messagesDiv = document.getElementById('messages');
        if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }

    // Handle textarea keydown: Enter submits, Shift+Enter adds new line
    function handleTextareaKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            event.target.form.requestSubmit();
        }
    }

    // Auto-resize textarea (called on input, handles typing and paste)
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }

    // Animate assistant response with staggered fade-in
    function animateAssistantResponse() {
        const messagesDiv = document.getElementById('messages');
        if (!messagesDiv) return;

        // Get the last assistant message (the newly inserted one)
        const assistantMessages = messagesDiv.querySelectorAll('.message.assistant:not(.thinking)');
        const lastMessage = assistantMessages[assistantMessages.length - 1];
        if (!lastMessage) return;

        // Get all block-level children
        const blocks = lastMessage.querySelectorAll('p, ul, ol, pre, h1, h2, h3, h4, h5, h6, blockquote, table, hr');

        // If no blocks found, treat the whole content as one block
        if (blocks.length === 0) {
            lastMessage.classList.add('fade-in-chunk');
            requestAnimationFrame(() => {
                lastMessage.classList.add('visible');
            });
            return;
        }

        // Add fade-in class to each block
        blocks.forEach(block => {
            block.classList.add('fade-in-chunk');
        });

        // Stagger the visibility with 300ms delay
        blocks.forEach((block, index) => {
            setTimeout(() => {
                block.classList.add('visible');
                scrollToBottom();
            }, index * 900);
        });
    }

    // Update sidebar highlight when switching sessions
    function updateSidebarHighlight(clickedButton) {
        // Remove 'current' class from all session items
        document.querySelectorAll('.session-item').forEach(item => {
            item.classList.remove('current');
        });
        // Add 'current' class to clicked button
        clickedButton.classList.add('current');
    }

    // Delete modal state (shared with Alpine)
    let deleteModalState = {
        showModal: false,
        sessionId: '',
        sessionTitle: ''
    };

    // Alpine.js component for delete modal
    function deleteModal() {
        return {
            showModal: false,
            sessionId: '',
            sessionTitle: '',
            init() {
                // Store reference so openDeleteModal can access this
                window.deleteModalComponent = this;
            }
        };
    }

    // Open delete modal (called from delete buttons)
    function openDeleteModal(sessionId, sessionTitle) {
        if (window.deleteModalComponent) {
            window.deleteModalComponent.sessionId = sessionId;
            window.deleteModalComponent.sessionTitle = sessionTitle;
            window.deleteModalComponent.showModal = true;
        }
    }

    // Alpine.js component for new chat modal
    function newChatModal() {
        return {
            showModal: false,
            init() {
                window.newChatModalComponent = this;
            }
        };
    }

    // Open new chat modal
    function openNewChatModal() {
        if (window.newChatModalComponent) {
            window.newChatModalComponent.showModal = true;
        }
    }

    // Alpine.js component for wipe memory modal
    function wipeMemoryModal() {
        return {
            showModal: false,
            init() {
                window.wipeMemoryModalComponent = this;
            },
            confirmWipe() {
                this.showModal = false;
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

                // Send wipe request via HTMX-style fetch
                fetch('{% url "wipe_memory" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'HX-Request': 'true'
                    }
                }).then(response => response.text())
                .then(html => {
                    const mainContent = document.getElementById('main-content');
                    mainContent.innerHTML = html;
                    htmx.process(mainContent);
                });
            }
        };
    }

    // Open wipe memory modal (called from memory page)
    function openWipeMemoryModal() {
        if (window.wipeMemoryModalComponent) {
            window.wipeMemoryModalComponent.showModal = true;
        }
    }

    // Alpine.js component for edit/new personality modal
    function editPersonalityModal() {
        return {
            showModal: false,
            isNew: false,         // true for new personality, false for edit
            personality: '',      // Original folder name (empty for new)
            displayName: '',      // User-editable display name
            content: '',
            init() {
                window.editPersonalityModalComponent = this;
            },
            savePersonality() {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

                // Convert display name to folder name format
                const newFolderName = this.displayName
                    .toLowerCase()
                    .replace(/\s+/g, '_')
                    .replace(/[^a-z0-9_]/g, '');

                const url = this.isNew ? '{% url "create_personality" %}' : '{% url "save_personality_file" %}';
                const body = this.isNew
                    ? `name=${encodeURIComponent(newFolderName)}&content=${encodeURIComponent(this.content)}`
                    : `personality=${encodeURIComponent(this.personality)}&new_name=${encodeURIComponent(newFolderName)}&content=${encodeURIComponent(this.content)}`;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken,
                        'HX-Request': 'true'
                    },
                    body: body
                })
                .then(response => response.text())
                .then(html => {
                    const mainContent = document.getElementById('main-content');
                    mainContent.innerHTML = html;
                    htmx.process(mainContent);  // Re-initialize HTMX on new content
                    this.showModal = false;
                });
            }
        };
    }

    // Open edit personality modal (called from settings page)
    function openEditPersonalityModal() {
        if (window.editPersonalityModalComponent) {
            const select = document.getElementById('personality');
            const personality = select ? select.value : '';
            const content = window.personalityRawContent || '';

            // Convert folder name to display name for editing
            const displayName = personality.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

            window.editPersonalityModalComponent.isNew = false;
            window.editPersonalityModalComponent.personality = personality;
            window.editPersonalityModalComponent.displayName = displayName;
            window.editPersonalityModalComponent.content = content;
            window.editPersonalityModalComponent.showModal = true;
        }
    }

    // Open new personality modal (called from settings page)
    function openNewPersonalityModal() {
        if (window.editPersonalityModalComponent) {
            window.editPersonalityModalComponent.isNew = true;
            window.editPersonalityModalComponent.personality = '';
            window.editPersonalityModalComponent.displayName = '';
            window.editPersonalityModalComponent.content = '';
            window.editPersonalityModalComponent.showModal = true;
        }
    }

    // Alpine.js component for delete personality modal
    function deletePersonalityModal() {
        return {
            showModal: false,
            personality: '',
            displayName: '',
            init() {
                window.deletePersonalityModalComponent = this;
            },
            confirmDelete() {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

                fetch('{% url "delete_personality" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken,
                        'HX-Request': 'true'
                    },
                    body: `personality=${encodeURIComponent(this.personality)}`
                })
                .then(response => response.text())
                .then(html => {
                    const mainContent = document.getElementById('main-content');
                    mainContent.innerHTML = html;
                    htmx.process(mainContent);
                    this.showModal = false;
                });
            }
        };
    }

    // Open delete personality modal (called from settings page)
    function openDeletePersonalityModal() {
        if (window.deletePersonalityModalComponent) {
            const select = document.getElementById('personality');
            const personality = select ? select.value : '';
            const displayName = personality.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

            window.deletePersonalityModalComponent.personality = personality;
            window.deletePersonalityModalComponent.displayName = displayName;
            window.deletePersonalityModalComponent.showModal = true;
        }
    }

    // Context Files Modal
    function contextFilesModal() {
        return {
            showModal: false,
            isDragging: false,
            files: [],
            uploadStatus: '',
            uploadStatusType: '',
            editModal: {
                show: false,
                filename: '',
                content: '',
                status: '',
                statusType: ''
            },

            init() {
                window.contextFilesModalComponent = this;
                this.loadFiles();
            },

            loadFiles() {
                this.files = window.contextFilesData || [];
            },

            handleDrop(event) {
                this.isDragging = false;
                const files = event.dataTransfer.files;
                this.uploadFiles(files);
            },

            handleFileSelect(event) {
                const files = event.target.files;
                this.uploadFiles(files);
                event.target.value = '';
            },

            async uploadFiles(fileList) {
                for (const file of fileList) {
                    if (!file.name.endsWith('.md') && !file.name.endsWith('.txt')) {
                        this.showStatus(`${file.name}: Invalid file type`, 'error');
                        continue;
                    }

                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                    try {
                        const response = await fetch('/memory/context/upload/', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.files = data.files;
                            window.contextFilesData = data.files;
                            this.showStatus(`Uploaded ${file.name}`, 'success');
                            this.updateBadge();
                        } else {
                            this.showStatus(`Failed to upload ${file.name}`, 'error');
                        }
                    } catch (err) {
                        this.showStatus(`Error uploading ${file.name}`, 'error');
                    }
                }
            },

            async toggleFile(filename) {
                const formData = new FormData();
                formData.append('filename', filename);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                const response = await fetch('/memory/context/toggle/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.ok) {
                    const data = await response.json();
                    this.files = data.files;
                    window.contextFilesData = data.files;
                }
            },

            async deleteFile(filename) {
                if (!confirm(`Delete ${filename}?`)) return;

                const formData = new FormData();
                formData.append('filename', filename);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                const response = await fetch('/memory/context/delete/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.ok) {
                    const data = await response.json();
                    this.files = data.files;
                    window.contextFilesData = data.files;
                    this.showStatus(`Deleted ${filename}`, 'success');
                    this.updateBadge();
                }
            },

            showStatus(message, type) {
                this.uploadStatus = message;
                this.uploadStatusType = type;
                setTimeout(() => {
                    this.uploadStatus = '';
                }, 3000);
            },

            updateBadge() {
                const badge = document.querySelector('.context-files-btn .badge');
                if (badge) {
                    badge.textContent = this.files.length;
                    badge.style.display = this.files.length > 0 ? 'inline' : 'none';
                }
            },

            async openEditFile(filename) {
                this.editModal.filename = filename;
                this.editModal.status = '';

                const response = await fetch(`/memory/context/content/?filename=${encodeURIComponent(filename)}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.ok) {
                    const data = await response.json();
                    this.editModal.content = data.content;
                    this.editModal.show = true;
                } else {
                    this.showStatus(`Failed to load ${filename}`, 'error');
                }
            },

            async saveEditFile() {
                const formData = new FormData();
                formData.append('filename', this.editModal.filename);
                formData.append('content', this.editModal.content);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                const response = await fetch('/memory/context/save/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.ok) {
                    this.editModal.status = 'Saved successfully';
                    this.editModal.statusType = 'success';
                    setTimeout(() => {
                        this.editModal.show = false;
                    }, 1000);
                } else {
                    this.editModal.status = 'Failed to save';
                    this.editModal.statusType = 'error';
                }
            }
        };
    }

    function openContextFilesModal() {
        if (window.contextFilesModalComponent) {
            window.contextFilesModalComponent.loadFiles();
            window.contextFilesModalComponent.showModal = true;
        }
    }

    // Show memory updating indicator (called via HTMX hx-on::before-request)
    function showMemoryUpdating() {
        const status = document.getElementById('memory-status');
        const btn = document.getElementById('update-memory-btn');
        if (status) {
            status.style.display = 'inline';
            status.innerHTML = ' ¬∑ Updating Memory<span class="updating-dots"><span>.</span><span>.</span><span>.</span></span>';
        }
        if (btn) btn.disabled = true;
    }

    // Show memory modifying indicator and clear input (called via HTMX hx-on::before-request)
    function showMemoryModifying(event) {
        // Clear input immediately
        const input = document.getElementById('memory-command-input');
        if (input) input.value = '';

        // Show updating status
        const status = document.getElementById('memory-status');
        if (status) {
            status.style.display = 'inline';
            status.innerHTML = ' ¬∑ Updating Memory<span class="updating-dots"><span>.</span><span>.</span><span>.</span></span>';
        }
    }

    // Listen for HTMX responses to update title when it changes
    document.body.addEventListener('htmx:afterRequest', function(event) {
        const xhr = event.detail.xhr;
        if (!xhr) return;

        const newTitle = xhr.getResponseHeader('X-Chat-Title');
        const sessionId = xhr.getResponseHeader('X-Chat-Session-Id');

        if (newTitle && sessionId) {
            // Update sidebar item
            const sidebarItem = document.querySelector(`.session-row[data-session-id="${sessionId}"] .session-item`);
            if (sidebarItem) {
                sidebarItem.textContent = newTitle;
            }

            // Update header title
            const headerTitle = document.querySelector('.header h1');
            if (headerTitle) {
                headerTitle.textContent = newTitle;
            }
        }

        // Convert timestamps and add date separators after HTMX swap
        convertTimestamps();
        insertDateSeparators();
    });

    // Set timezone hidden input value
    function setTimezoneInput() {
        const input = document.getElementById('timezone-input');
        if (input) {
            input.value = Intl.DateTimeFormat().resolvedOptions().timeZone;
        }
    }

    // Convert UTC timestamps to local time (always show time)
    function convertTimestamps() {
        const timestamps = document.querySelectorAll('.timestamp[data-utc]');

        timestamps.forEach(el => {
            const utc = el.getAttribute('data-utc');
            if (!utc || el.textContent) return; // Skip if already converted

            try {
                const date = new Date(utc);
                if (isNaN(date.getTime())) return;

                // Always show time
                el.textContent = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            } catch (e) {
                // Silently fail for invalid timestamps
            }
        });
    }

    // Format date for separator (Today, Yesterday, or full date)
    function formatDateSeparator(date) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

        if (messageDate.getTime() === today.getTime()) {
            return 'Today';
        } else if (messageDate.getTime() === yesterday.getTime()) {
            return 'Yesterday';
        } else {
            return date.toLocaleDateString([], { month: 'long', day: 'numeric', year: 'numeric' });
        }
    }

    // Insert date separators above first message of each date
    function insertDateSeparators() {
        const messagesDiv = document.getElementById('messages');
        if (!messagesDiv) return;

        const containers = messagesDiv.querySelectorAll('.message-container');
        let lastDateStr = null;

        containers.forEach(container => {
            const timestamp = container.querySelector('.timestamp[data-utc]');
            if (!timestamp) return;

            const utc = timestamp.getAttribute('data-utc');
            if (!utc) return;

            try {
                const date = new Date(utc);
                if (isNaN(date.getTime())) return;

                const dateStr = date.toDateString();

                if (dateStr !== lastDateStr) {
                    // Check if separator already exists
                    const prevSibling = container.previousElementSibling;
                    if (prevSibling && prevSibling.classList.contains('date-separator')) {
                        lastDateStr = dateStr;
                        return;
                    }

                    // Insert new date separator
                    const separator = document.createElement('div');
                    separator.className = 'date-separator';
                    separator.textContent = formatDateSeparator(date);
                    container.parentNode.insertBefore(separator, container);

                    lastDateStr = dateStr;
                }
            } catch (e) {
                // Silently fail
            }
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        setTimezoneInput();
        convertTimestamps();
        insertDateSeparators();
    });
</script>
{% endblock %}
