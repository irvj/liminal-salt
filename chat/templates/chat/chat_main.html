{% load markdown_extras %}
<!-- Header -->
<header class="header">
    <h1>{{ title }}</h1>
    <div class="subtitle">
        Personality: {{ personality|display_name }} | Model: {{ model }}
    </div>
</header>

<!-- Messages -->
<div class="messages" id="messages">
    {% for message in messages %}
        <div class="message-container {{ message.role }}">
            <div class="message {{ message.role }}">
                {% if message.content|slice:":6" == "ERROR:" %}
                    <strong>⚠️ Error:</strong><br>
                    <pre>{{ message.content|slice:"6:" }}</pre>
                {% else %}
                    {{ message.content|markdown }}
                {% endif %}
            </div>
            {% if message.timestamp %}
            <span class="timestamp" data-utc="{{ message.timestamp }}"></span>
            {% endif %}
        </div>
    {% endfor %}
</div>

<!-- Input Area -->
<div class="input-area">
    <form method="POST"
          hx-post="{% url 'send_message' %}"
          hx-target="#messages"
          hx-swap="beforeend"
          hx-on::before-request="addUserMessage(event)"
          hx-on::after-request="this.reset(); removeThinkingIndicator(); animateAssistantResponse();">
        {% csrf_token %}
        <input type="hidden" name="timezone" id="timezone-input" value="">
        <textarea
            name="message"
            id="message-input"
            placeholder="What's on your mind?"
            required
            autocomplete="off"
            autofocus
            rows="1"
            onkeydown="handleTextareaKeydown(event)"
            oninput="autoResizeTextarea(this)"
        ></textarea>
        <button type="submit">Send</button>
    </form>
</div>

<script>
    // Auto-scroll to bottom when this partial loads
    (function() {
        const messagesDiv = document.getElementById('messages');
        if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    })();
</script>

<!-- OOB: Update sidebar sessions -->
<div id="sidebar-sessions" hx-swap-oob="true">
{% include "chat/sidebar_sessions.html" %}
</div>
