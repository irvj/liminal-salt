{% load markdown_extras %}
<script>
    window.personaModelsData = {{ persona_models_json|default:"{}"|safe }};
    window.defaultModelData = '{{ default_model|default:""|escapejs }}';
</script>
<!-- Centered content -->
<div class="flex-1 flex flex-col items-center justify-center p-5">
    <form method="POST"
          hx-post="{% url 'start_chat' %}"
          hx-target="#main-content"
          hx-swap="innerHTML"
          class="w-full max-w-xl"
          x-data="{
              open: false,
              selected: '{{ default_persona }}',
              selectedDisplay: '',
              highlightedIndex: 0,
              personas: [{% for p in personas %}{ id: '{{ p }}', display: '{{ p|display_name|escapejs }}' }{% if not forloop.last %}, {% endif %}{% endfor %}],
              personaModels: window.personaModelsData || {},
              defaultModel: window.defaultModelData || '',
              get filteredPersonas() {
                  return this.personas;
              },
              get currentModel() {
                  return this.personaModels[this.selected] || this.defaultModel;
              },
              get currentModelDisplay() {
                  const model = this.currentModel;
                  // Extract just the model name (after the slash)
                  return model.includes('/') ? model.split('/').pop() : model;
              },
              selectPersona(p) {
                  this.selected = p.id;
                  this.selectedDisplay = p.display;
                  this.open = false;
              },
              selectHighlighted() {
                  if (this.filteredPersonas.length > 0) {
                      this.selectPersona(this.filteredPersonas[this.highlightedIndex]);
                  }
              },
              highlightNext() {
                  if (this.highlightedIndex < this.filteredPersonas.length - 1) {
                      this.highlightedIndex++;
                      this.scrollToHighlighted();
                  }
              },
              highlightPrev() {
                  if (this.highlightedIndex > 0) {
                      this.highlightedIndex--;
                      this.scrollToHighlighted();
                  }
              },
              scrollToHighlighted() {
                  this.$nextTick(() => {
                      const dropdown = this.$root.querySelector('.max-h-64');
                      const buttons = dropdown?.querySelectorAll('button');
                      const highlighted = buttons?.[this.highlightedIndex];
                      if (dropdown && highlighted) {
                          const itemTop = highlighted.offsetTop;
                          const itemBottom = itemTop + highlighted.offsetHeight;
                          const viewTop = dropdown.scrollTop;
                          const viewBottom = viewTop + dropdown.clientHeight;
                          if (itemBottom > viewBottom) {
                              dropdown.scrollTop = itemBottom - dropdown.clientHeight;
                          } else if (itemTop < viewTop) {
                              dropdown.scrollTop = itemTop;
                          }
                      }
                  });
              },
              init() {
                  const found = this.personas.find(p => p.id === this.selected);
                  if (found) this.selectedDisplay = found.display;
              }
          }">
        {% csrf_token %}
        <input type="hidden" name="timezone" id="timezone-input" value="">
        <input type="hidden" name="persona" :value="selected">

        <!-- Title -->
        <h1 class="text-4xl text-accent-cyan mb-6">Liminal Salt</h1>

        <!-- Chat input -->
        <div class="flex gap-3 items-end mb-3">
            <input type="text"
                   name="message"
                   id="message-input"
                   placeholder="What's on your mind?"
                   required
                   autocomplete="off"
                   autofocus
                   class="flex-1 p-3 border border-border rounded bg-surface text-foreground text-base focus:outline-none focus:border-accent-cyan">
            <button type="submit" class="px-6 py-3 bg-accent text-foreground-on-accent border border-accent rounded cursor-pointer font-medium text-base hover:bg-accent-hover">Send</button>
        </div>

        <!-- Persona picker and model display -->
        <div class="flex items-center gap-4">
            <div class="relative">
                <button type="button"
                        @click="open = !open"
                        class="flex items-center gap-1 text-foreground-secondary hover:text-foreground text-sm cursor-pointer">
                    {% include 'icons/user-pen.html' with class='w-4 h-4' %}
                    <span x-text="selectedDisplay"></span>
                </button>

                <!-- Dropdown -->
            <div x-cloak
                 x-show="open"
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:leave="transition ease-in duration-75"
                 @click.away="open = false"
                 @keydown.escape="open = false"
                 @keydown.arrow-down.prevent="highlightNext()"
                 @keydown.arrow-up.prevent="highlightPrev()"
                 @keydown.enter.prevent="selectHighlighted()"
                 class="absolute bottom-full left-0 mb-1 min-w-[200px] max-h-64 overflow-y-auto bg-surface-secondary border border-border rounded-lg shadow-lg z-10">
                <template x-for="(p, index) in filteredPersonas" :key="p.id">
                    <button type="button"
                            @click="selectPersona(p)"
                            @mouseenter="highlightedIndex = index"
                            :class="index === highlightedIndex ? 'bg-accent text-foreground-on-accent' : 'text-foreground hover:bg-surface-elevated'"
                            class="block w-full px-4 py-2 text-left text-sm cursor-pointer">
                        <span x-text="p.display"></span>
                    </button>
                </template>
            </div>
            </div>

            <!-- Model display -->
            <span class="text-foreground-secondary text-sm flex items-center gap-1">
                {% include 'icons/cpu.html' with class='w-4 h-4' %}
                <span x-text="currentModelDisplay"></span>
            </span>
        </div>
    </form>
</div>

<script>
    // Set timezone
    (function() {
        const tzInput = document.getElementById('timezone-input');
        if (tzInput) {
            tzInput.value = Intl.DateTimeFormat().resolvedOptions().timeZone;
        }
    })();
</script>

{% if is_htmx %}
<!-- OOB: Update sidebar sessions -->
<div id="sidebar-sessions" hx-swap-oob="true">
{% include "chat/sidebar_sessions.html" %}
</div>
{% endif %}
