{% load markdown_extras %}
<!-- Header -->
<header class="bg-surface-secondary px-5 py-4 border-b border-border">
    <h1 class="text-2xl text-accent-cyan">Settings</h1>
</header>

<!-- Settings Content -->
<div class="flex-1 overflow-y-auto p-5">
    {% if success %}
    <div class="p-3 px-4 rounded mb-4 bg-success text-surface flex items-center gap-2">{% include 'icons/check-circle.html' with class='w-5 h-5' %} {{ success }}</div>
    {% endif %}

    <!-- Theme Section -->
    <h2 class="text-accent-cyan text-xl mb-4">Theme</h2>
    <div class="mb-6">
        <!-- Color Theme Picker -->
        <div class="mb-4" x-data="themePicker">
            <label class="block mb-2 font-medium">Color Theme:</label>
            <div class="relative max-w-md">
                <button type="button"
                        @click.stop="open = !open"
                        class="w-full p-3 border rounded text-left flex items-center justify-between cursor-pointer"
                        :class="selected ? 'border-accent-cyan bg-surface' : 'border-border bg-surface-secondary'">
                    <span x-text="selectedDisplay || 'Select a theme...'"></span>
                    <svg class="w-4 h-4 text-foreground-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div x-cloak
                     x-show="open"
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:leave="transition ease-in duration-75"
                     @click.away="open = false"
                     class="absolute w-full mt-1 bg-surface-secondary border border-border rounded-lg shadow-lg z-10">
                    <template x-for="theme in themes" :key="theme.id">
                        <button type="button"
                                @click="selectTheme(theme)"
                                :class="selected === theme.id ? 'bg-accent text-foreground-on-accent' : 'text-foreground hover:bg-surface-elevated'"
                                class="block w-full px-4 py-2 text-left text-sm cursor-pointer">
                            <span x-text="theme.name"></span>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Dark/Light Mode Toggle -->
        <div x-data="themeModeToggle">
            <label class="block mb-2 font-medium">Mode:</label>
            <div class="flex gap-3">
                <button @click="setMode('dark')"
                        :class="isDark ? 'bg-accent text-foreground-on-accent' : 'bg-border text-foreground hover:bg-accent hover:text-foreground-on-accent'"
                        class="flex items-center gap-2 px-4 py-2 rounded font-medium cursor-pointer">
                    {% include 'icons/moon.html' with class='w-5 h-5' %} Dark
                </button>
                <button @click="setMode('light')"
                        :class="!isDark ? 'bg-accent text-foreground-on-accent' : 'bg-border text-foreground hover:bg-accent hover:text-foreground-on-accent'"
                        class="flex items-center gap-2 px-4 py-2 rounded font-medium cursor-pointer">
                    {% include 'icons/sun.html' with class='w-5 h-5' %} Light
                </button>
            </div>
        </div>
    </div>

    <!-- Provider & Model Section -->
    <h2 class="text-accent-cyan text-xl mb-4">Provider & Model</h2>
    <div class="mb-6"
         x-data="providerModelSettings"
         data-provider="{{ provider }}"
         data-provider-name="{% for p in providers %}{% if p.id == provider %}{{ p.name }}{% endif %}{% endfor %}"
         data-model="{{ model }}"
         data-has-existing-key="{{ has_api_key|yesno:'true,false' }}"
         data-providers='{{ providers_json|safe }}'
         data-validate-url="{% url 'validate_provider_api_key' %}"
         data-save-url="{% url 'save_provider_model' %}"
         data-csrf-token="{{ csrf_token }}">
        <!-- Status Messages -->
        <div x-show="statusMessage" x-transition
             :class="statusType === 'success' ? 'bg-success text-surface' : 'bg-danger text-white'"
             class="p-3 px-4 rounded mb-4">
            <span x-text="statusMessage"></span>
        </div>

        <!-- Provider Picker -->
        <div class="mb-4">
            <label class="block mb-2 font-medium">Provider:</label>
            <div class="relative">
                <button type="button"
                        @click.stop="providerOpen = !providerOpen"
                        class="w-full max-w-md p-3 border rounded text-left flex items-center justify-between cursor-pointer"
                        :class="selectedProvider ? 'border-accent-cyan bg-surface' : 'border-border bg-surface-secondary'">
                    <span x-text="selectedProviderName || 'Select a provider...'"></span>
                    <svg class="w-4 h-4 text-foreground-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div x-cloak
                     x-show="providerOpen"
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:leave="transition ease-in duration-75"
                     @click.away="providerOpen = false"
                     class="absolute w-full max-w-md mt-1 bg-surface-secondary border border-border rounded-lg shadow-lg z-10">
                    <template x-for="p in providers" :key="p.id">
                        <button type="button"
                                @click="selectProvider(p)"
                                :class="selectedProvider === p.id ? 'bg-accent text-foreground-on-accent' : 'text-foreground hover:bg-surface-elevated'"
                                class="block w-full px-4 py-2 text-left text-sm cursor-pointer">
                            <span x-text="p.name"></span>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- API Key Field -->
        <div class="mb-4">
            <label class="block mb-2 font-medium">API Key:</label>
            <p class="text-foreground-secondary text-sm mb-2">
                <template x-if="currentProviderData">
                    <span>Get your API key from
                        <a :href="currentProviderData.api_key_url" target="_blank" class="text-accent-cyan hover:underline" x-text="currentProviderData.name"></a>
                    </span>
                </template>
            </p>
            <div class="flex gap-2 items-center max-w-md">
                <input type="password"
                       x-model="apiKey"
                       @input="onApiKeyChange()"
                       :placeholder="hasExistingKey && !apiKeyModified ? '••••••••••••••••' : (currentProviderData?.api_key_placeholder || 'Enter API key...')"
                       class="flex-1 p-3 border border-border rounded bg-surface-secondary text-foreground text-base focus:outline-none focus:border-accent-cyan">
                <button type="button"
                        @click="validateApiKey()"
                        x-show="apiKeyModified && apiKey"
                        :disabled="validating"
                        class="px-4 py-3 bg-accent text-white rounded font-medium cursor-pointer hover:bg-accent-hover disabled:opacity-50">
                    <span x-show="!validating">Validate</span>
                    <span x-show="validating">...</span>
                </button>
                <span x-show="apiKeyValid && !apiKeyModified" class="text-success">{% include 'icons/check.html' with class='w-6 h-6' %}</span>
            </div>
            <p x-show="apiKeyError" class="text-danger text-sm mt-1" x-text="apiKeyError"></p>
        </div>

        <!-- Model Picker -->
        <div class="mb-4" x-show="showModelPicker">
            <label class="block mb-2 font-medium">Default Model:</label>
            <div class="relative max-w-md">
                <input type="text"
                       x-model="modelSearch"
                       @input="modelHighlightedIndex = 0"
                       @focus="modelOpen = true"
                       @click.stop="modelOpen = true"
                       @keydown.escape="modelOpen = false"
                       @keydown.enter.prevent="selectHighlightedModel()"
                       @keydown.arrow-down.prevent="highlightNextModel()"
                       @keydown.arrow-up.prevent="highlightPrevModel()"
                       placeholder="Search models..."
                       :class="selectedModel ? 'border-accent-cyan bg-surface' : 'border-border bg-surface-secondary'"
                       class="w-full p-3 border rounded text-foreground text-base focus:outline-none focus:border-accent-cyan">

                <div x-cloak
                     x-show="modelOpen && filteredModels.length > 0"
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:leave="transition ease-in duration-75"
                     @click.away="modelOpen = false"
                     class="absolute w-full mt-1 max-h-64 overflow-y-auto bg-surface-secondary border border-border rounded-lg shadow-lg z-10">
                    <template x-for="(m, index) in filteredModels" :key="m.id">
                        <button type="button"
                                @click="selectModel(m)"
                                @mouseenter="modelHighlightedIndex = index"
                                :class="index === modelHighlightedIndex ? 'bg-accent text-foreground-on-accent' : 'text-foreground hover:bg-surface-elevated'"
                                class="block w-full px-4 py-2 text-left text-sm cursor-pointer">
                            <span x-text="m.display"></span>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <button type="button"
                @click="saveProviderModel()"
                :disabled="!canSave || saving"
                class="px-6 py-3 bg-accent text-foreground-on-accent rounded font-medium cursor-pointer hover:bg-accent-hover disabled:bg-border disabled:text-foreground-muted disabled:cursor-not-allowed">
            <span x-show="!saving">Save Provider & Model</span>
            <span x-show="saving">Saving...</span>
        </button>
    </div>
</div>

<!-- Out-of-band swap: Update New Chat button in sidebar -->
<div id="new-chat-button" hx-swap-oob="true">
{% include "chat/new_chat_button.html" %}
</div>
