{% load markdown_extras %}
<!-- Header -->
<header class="bg-surface-secondary px-5 py-4 border-b border-border">
    <h1 class="text-2xl text-accent-cyan">Settings</h1>
    <div class="text-xs text-foreground-secondary mt-1">Model: {{ model }}</div>
</header>

<!-- Settings Content -->
<div class="flex-1 overflow-y-auto p-5">
    {% if success %}
    <div class="p-3 px-4 rounded mb-4 bg-success text-surface">‚úÖ {{ success }}</div>
    {% endif %}

    <!-- Theme Section -->
    <h2 class="text-accent-cyan text-xl mb-4">Theme</h2>
    <div class="mb-6">
        <p class="text-foreground-secondary text-sm mb-3">Choose your preferred color theme:</p>
        <div class="flex gap-3">
            <button onclick="setTheme('dark')" class="px-4 py-2 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent" id="theme-dark-btn">
                üåô Dark
            </button>
            <button onclick="setTheme('light')" class="px-4 py-2 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent" id="theme-light-btn">
                ‚òÄÔ∏è Light
            </button>
        </div>
        <script>
            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                updateThemeButtons(theme);
            }
            function updateThemeButtons(theme) {
                const darkBtn = document.getElementById('theme-dark-btn');
                const lightBtn = document.getElementById('theme-light-btn');
                if (theme === 'dark') {
                    darkBtn.classList.add('bg-accent', 'text-foreground-on-accent');
                    darkBtn.classList.remove('bg-surface-elevated');
                    lightBtn.classList.remove('bg-accent', 'text-foreground-on-accent');
                    lightBtn.classList.add('bg-surface-elevated');
                } else {
                    lightBtn.classList.add('bg-accent', 'text-foreground-on-accent');
                    lightBtn.classList.remove('bg-surface-elevated');
                    darkBtn.classList.remove('bg-accent', 'text-foreground-on-accent');
                    darkBtn.classList.add('bg-surface-elevated');
                }
            }
            // Initialize button state
            (function() {
                const theme = localStorage.getItem('theme') || 'dark';
                updateThemeButtons(theme);
            })();
        </script>
    </div>

    <h2 class="text-accent-cyan text-xl mb-4">Chat Personality</h2>

    {% if not personalities %}
    <div class="p-3 px-4 rounded mb-4 bg-danger text-white">
        No personalities found in 'personalities/' directory.
        Create personality folders with .md files to define chatbot personalities.
    </div>
    {% else %}

    <p class="text-foreground-secondary text-sm mb-4"><strong>Default personality for new chats:</strong> {{ default_personality|display_name }}</p>

    <form hx-post="{% url 'save_settings' %}"
          hx-target="#main-content"
          hx-swap="innerHTML">
        {% csrf_token %}
        <div class="mb-4">
            <label class="block mb-2 font-medium">Select a personality:</label>
            <div class="relative" x-data="{ open: false, selected: '{{ selected_personality }}' }">
                <input type="hidden" name="personality" :value="selected">

                <!-- Trigger button -->
                <button type="button"
                        @click="open = !open"
                        class="flex items-center gap-2 px-4 py-2.5 border border-border rounded bg-surface text-foreground cursor-pointer hover:border-accent-cyan">
                    <span x-text="selected.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())"></span>
                    <svg class="w-4 h-4 text-foreground-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <!-- Popup menu -->
                <div x-show="open"
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:leave="transition ease-in duration-75"
                     @click.away="open = false"
                     class="absolute top-full left-0 mt-2 bg-surface-secondary border border-border rounded-lg shadow-lg overflow-hidden min-w-[200px] z-10">
                    {% for p in personalities %}
                    <button type="button"
                            @click="selected = '{{ p }}'; open = false"
                            hx-get="{% url 'settings' %}?preview={{ p }}"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            :class="selected === '{{ p }}' ? 'bg-accent text-foreground-on-accent' : 'text-foreground hover:bg-surface-elevated'"
                            class="block w-full px-4 py-2 text-left text-sm cursor-pointer">
                        {{ p|display_name }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="flex gap-3 flex-wrap">
            <button type="submit" class="px-6 py-3 bg-accent text-white rounded font-medium cursor-pointer hover:bg-accent-hover">Set as Default</button>
            <button type="button" class="px-6 py-3 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent" onclick="openEditPersonalityModal()">Edit Personality</button>
            <button type="button" class="px-6 py-3 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent" onclick="openNewPersonalityModal()">New Personality</button>
            <button type="button" class="px-6 py-3 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-danger hover:text-foreground-on-accent" onclick="openDeletePersonalityModal()">Delete Personality</button>
        </div>
    </form>

    <script>
        window.personalityRawContent = "{{ personality_preview|escapejs }}";
    </script>

    {% if personality_preview %}
    <div class="bg-surface-secondary p-5 rounded-lg leading-relaxed border-l-4 border-accent mt-5 prose prose-invert max-w-none">
        {{ personality_preview|markdown }}
    </div>
    {% endif %}

    {% endif %}
</div>

<!-- Out-of-band swap: Update New Chat button in sidebar -->
<div id="new-chat-button" hx-swap-oob="true">
{% include "chat/new_chat_button.html" %}
</div>
