{% load markdown_extras %}
<!-- Header -->
<header class="bg-surface-secondary px-5 py-4 border-b border-border">
    <h1 class="text-2xl text-accent-cyan">Settings</h1>
</header>

<!-- Settings Content -->
<div class="flex-1 overflow-y-auto p-5">
    {% if success %}
    <div class="p-3 px-4 rounded mb-4 bg-success text-surface flex items-center gap-2">{% include 'icons/check-circle.html' with class='w-5 h-5' %} {{ success }}</div>
    {% endif %}

    <!-- Theme Section -->
    <h2 class="text-accent-cyan text-xl mb-4">Theme</h2>
    <div class="mb-6">
        <p class="text-foreground-secondary text-sm mb-3">Choose your preferred color theme:</p>
        <div class="flex gap-3">
            <button onclick="setTheme('dark')" class="flex items-center gap-2 px-4 py-2 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent" id="theme-dark-btn">
                {% include 'icons/moon.html' with class='w-5 h-5' %} Dark
            </button>
            <button onclick="setTheme('light')" class="flex items-center gap-2 px-4 py-2 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent" id="theme-light-btn">
                {% include 'icons/sun.html' with class='w-5 h-5' %} Light
            </button>
        </div>
        <script>
            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                updateThemeButtons(theme);
            }
            function updateThemeButtons(theme) {
                const darkBtn = document.getElementById('theme-dark-btn');
                const lightBtn = document.getElementById('theme-light-btn');
                if (theme === 'dark') {
                    darkBtn.classList.add('bg-accent', 'text-foreground-on-accent');
                    darkBtn.classList.remove('bg-surface-elevated');
                    lightBtn.classList.remove('bg-accent', 'text-foreground-on-accent');
                    lightBtn.classList.add('bg-surface-elevated');
                } else {
                    lightBtn.classList.add('bg-accent', 'text-foreground-on-accent');
                    lightBtn.classList.remove('bg-surface-elevated');
                    darkBtn.classList.remove('bg-accent', 'text-foreground-on-accent');
                    darkBtn.classList.add('bg-surface-elevated');
                }
            }
            // Initialize button state
            (function() {
                const theme = localStorage.getItem('theme') || 'dark';
                updateThemeButtons(theme);
            })();
        </script>
    </div>

    <!-- Provider & Model Section -->
    <h2 class="text-accent-cyan text-xl mb-4">Provider & Model</h2>
    <div class="mb-6"
         x-data="providerModelSettings()"
         data-provider="{{ provider }}"
         data-provider-name="{% for p in providers %}{% if p.id == provider %}{{ p.name }}{% endif %}{% endfor %}"
         data-model="{{ model }}"
         data-has-existing-key="{{ has_api_key|yesno:'true,false' }}"
         data-providers='{{ providers_json|safe }}'
         data-validate-url="{% url 'validate_provider_api_key' %}"
         data-save-url="{% url 'save_provider_model' %}"
         data-csrf-token="{{ csrf_token }}">
        <!-- Status Messages -->
        <div x-show="statusMessage" x-transition
             :class="statusType === 'success' ? 'bg-success text-surface' : 'bg-danger text-white'"
             class="p-3 px-4 rounded mb-4">
            <span x-text="statusMessage"></span>
        </div>

        <!-- Provider Picker -->
        <div class="mb-4">
            <label class="block mb-2 font-medium">Provider:</label>
            <div class="relative">
                <button type="button"
                        @click.stop="providerOpen = !providerOpen"
                        class="w-full max-w-md p-3 border rounded text-left flex items-center justify-between cursor-pointer"
                        :class="selectedProvider ? 'border-accent-cyan bg-surface' : 'border-border bg-surface-secondary'">
                    <span x-text="selectedProviderName || 'Select a provider...'"></span>
                    <svg class="w-4 h-4 text-foreground-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div x-cloak
                     x-show="providerOpen"
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:leave="transition ease-in duration-75"
                     @click.away="providerOpen = false"
                     class="absolute w-full max-w-md mt-1 bg-surface-secondary border border-border rounded-lg shadow-lg z-10">
                    <template x-for="p in providers" :key="p.id">
                        <button type="button"
                                @click="selectProvider(p)"
                                :class="selectedProvider === p.id ? 'bg-accent text-foreground-on-accent' : 'text-foreground hover:bg-surface-elevated'"
                                class="block w-full px-4 py-2 text-left text-sm cursor-pointer">
                            <span x-text="p.name"></span>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- API Key Field -->
        <div class="mb-4">
            <label class="block mb-2 font-medium">API Key:</label>
            <p class="text-foreground-secondary text-sm mb-2">
                <template x-if="currentProviderData">
                    <span>Get your API key from
                        <a :href="currentProviderData.api_key_url" target="_blank" class="text-accent-cyan hover:underline" x-text="currentProviderData.name"></a>
                    </span>
                </template>
            </p>
            <div class="flex gap-2 items-center max-w-md">
                <input type="password"
                       x-model="apiKey"
                       @input="onApiKeyChange()"
                       :placeholder="hasExistingKey && !apiKeyModified ? '••••••••••••••••' : (currentProviderData?.api_key_placeholder || 'Enter API key...')"
                       class="flex-1 p-3 border border-border rounded bg-surface-secondary text-foreground text-base focus:outline-none focus:border-accent-cyan">
                <button type="button"
                        @click="validateApiKey()"
                        x-show="apiKeyModified && apiKey"
                        :disabled="validating"
                        class="px-4 py-3 bg-accent text-white rounded font-medium cursor-pointer hover:bg-accent-hover disabled:opacity-50">
                    <span x-show="!validating">Validate</span>
                    <span x-show="validating">...</span>
                </button>
                <span x-show="apiKeyValid && !apiKeyModified" class="text-success">{% include 'icons/check.html' with class='w-6 h-6' %}</span>
            </div>
            <p x-show="apiKeyError" class="text-danger text-sm mt-1" x-text="apiKeyError"></p>
        </div>

        <!-- Model Picker -->
        <div class="mb-4" x-show="showModelPicker">
            <label class="block mb-2 font-medium">Model:</label>
            <div class="relative max-w-md">
                <input type="text"
                       x-model="modelSearch"
                       @input="modelHighlightedIndex = 0"
                       @focus="modelOpen = true"
                       @click.stop="modelOpen = true"
                       @keydown.escape="modelOpen = false"
                       @keydown.enter.prevent="selectHighlightedModel()"
                       @keydown.arrow-down.prevent="highlightNextModel()"
                       @keydown.arrow-up.prevent="highlightPrevModel()"
                       placeholder="Search models..."
                       :class="selectedModel ? 'border-accent-cyan bg-surface' : 'border-border bg-surface-secondary'"
                       class="w-full p-3 border rounded text-foreground text-base focus:outline-none focus:border-accent-cyan">

                <div x-cloak
                     x-show="modelOpen && filteredModels.length > 0"
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:leave="transition ease-in duration-75"
                     @click.away="modelOpen = false"
                     class="absolute w-full mt-1 max-h-64 overflow-y-auto bg-surface-secondary border border-border rounded-lg shadow-lg z-10">
                    <template x-for="(m, index) in filteredModels" :key="m.id">
                        <button type="button"
                                @click="selectModel(m)"
                                @mouseenter="modelHighlightedIndex = index"
                                :class="index === modelHighlightedIndex ? 'bg-accent text-foreground-on-accent' : 'text-foreground hover:bg-surface-elevated'"
                                class="block w-full px-4 py-2 text-left text-sm cursor-pointer">
                            <span x-text="m.display"></span>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <button type="button"
                @click="saveProviderModel()"
                :disabled="!canSave || saving"
                class="px-6 py-3 bg-accent text-white rounded font-medium cursor-pointer hover:bg-accent-hover disabled:bg-surface-elevated disabled:cursor-not-allowed">
            <span x-show="!saving">Save Provider & Model</span>
            <span x-show="saving">Saving...</span>
        </button>
    </div>

    <h2 class="text-accent-cyan text-xl mb-4">Chat Personality</h2>

    {% if not personalities %}
    <div class="p-3 px-4 rounded mb-4 bg-danger text-white">
        No personalities found in 'personalities/' directory.
        Create personality folders with .md files to define chatbot personalities.
    </div>
    {% else %}

    <p class="text-foreground-secondary text-sm mb-4"><strong>Default personality for new chats:</strong> {{ default_personality|display_name }}</p>

    <form hx-post="{% url 'save_settings' %}"
          hx-target="#main-content"
          hx-swap="innerHTML">
        {% csrf_token %}
        <div class="mb-4"
             x-data="{
                 open: false,
                 search: '',
                 selected: '{{ selected_personality }}',
                 highlightedIndex: 0,
                 personalities: [{% for p in personalities %}{ id: '{{ p }}', display: '{{ p|display_name|escapejs }}' }{% if not forloop.last %}, {% endif %}{% endfor %}],
                 settingsUrl: '{% url 'settings' %}',
                 get filteredPersonalities() {
                     const found = this.personalities.find(p => p.id === this.selected);
                     if (found && this.search === found.display) return this.personalities;
                     if (!this.search) return this.personalities;
                     const s = this.search.toLowerCase();
                     return this.personalities.filter(p => p.display.toLowerCase().includes(s) || p.id.toLowerCase().includes(s));
                 },
                 selectPersonality(p) {
                     this.selected = p.id;
                     this.search = p.display;
                     this.open = false;
                     // Trigger HTMX preview (preserve scroll position)
                     const scrollContainer = document.querySelector('#main-content .overflow-y-auto');
                     const scrollPos = scrollContainer ? scrollContainer.scrollTop : 0;
                     htmx.ajax('GET', this.settingsUrl + '?preview=' + p.id, {target: '#main-content', swap: 'innerHTML'}).then(() => {
                         if (scrollContainer) {
                             const newScrollContainer = document.querySelector('#main-content .overflow-y-auto');
                             if (newScrollContainer) newScrollContainer.scrollTop = scrollPos;
                         }
                     });
                 },
                 selectHighlighted() {
                     if (this.filteredPersonalities.length > 0) {
                         this.selectPersonality(this.filteredPersonalities[this.highlightedIndex]);
                     }
                 },
                 highlightNext() {
                     if (this.highlightedIndex < this.filteredPersonalities.length - 1) {
                         this.highlightedIndex++;
                         this.scrollToHighlighted();
                     }
                 },
                 highlightPrev() {
                     if (this.highlightedIndex > 0) {
                         this.highlightedIndex--;
                         this.scrollToHighlighted();
                     }
                 },
                 scrollToHighlighted() {
                     this.$nextTick(() => {
                         const dropdown = this.$root.querySelector('.max-h-64');
                         const buttons = dropdown?.querySelectorAll('button');
                         const highlighted = buttons?.[this.highlightedIndex];
                         if (dropdown && highlighted) {
                             const itemTop = highlighted.offsetTop;
                             const itemBottom = itemTop + highlighted.offsetHeight;
                             const viewTop = dropdown.scrollTop;
                             const viewBottom = viewTop + dropdown.clientHeight;
                             if (itemBottom > viewBottom) {
                                 dropdown.scrollTop = itemBottom - dropdown.clientHeight;
                             } else if (itemTop < viewTop) {
                                 dropdown.scrollTop = itemTop;
                             }
                         }
                     });
                 },
                 init() {
                     const found = this.personalities.find(p => p.id === this.selected);
                     if (found) this.search = found.display;
                 }
             }">
            <label class="block mb-2 font-medium">Select a personality:</label>
            <input type="hidden" name="personality" id="personality" :value="selected">
            <div class="relative max-w-md">
                <input type="text"
                       x-model="search"
                       @input="highlightedIndex = 0"
                       @focus="open = true"
                       @click.stop="open = true"
                       @keydown.escape="open = false"
                       @keydown.enter.prevent="selectHighlighted()"
                       @keydown.arrow-down.prevent="highlightNext()"
                       @keydown.arrow-up.prevent="highlightPrev()"
                       placeholder="Search personalities..."
                       :class="selected ? 'border-accent-cyan bg-surface' : 'border-border bg-surface-secondary'"
                       class="w-full p-3 pr-10 border rounded text-foreground text-base focus:outline-none focus:border-accent-cyan">
                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-foreground-secondary pointer-events-none">{% include 'icons/chevron-down.html' with class='w-4 h-4' %}</span>

                <!-- Dropdown -->
                <div x-cloak
                     x-show="open && filteredPersonalities.length > 0"
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:leave="transition ease-in duration-75"
                     @click.away="open = false"
                     class="absolute w-full mt-1 max-h-64 overflow-y-auto bg-surface-secondary border border-border rounded-lg shadow-lg z-10">
                    <template x-for="(p, index) in filteredPersonalities" :key="p.id">
                        <button type="button"
                                @click="selectPersonality(p)"
                                @mouseenter="highlightedIndex = index"
                                :class="index === highlightedIndex ? 'bg-accent text-foreground-on-accent' : 'text-foreground hover:bg-surface-elevated'"
                                class="block w-full px-4 py-2 text-left text-sm cursor-pointer">
                            <span x-text="p.display"></span>
                        </button>
                    </template>
                </div>
            </div>

            <div class="flex gap-3 flex-wrap mt-4">
                <button type="submit" class="px-6 py-3 bg-accent text-white rounded font-medium cursor-pointer hover:bg-accent-hover">Set as Default</button>
                <button type="button" class="px-6 py-3 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent" onclick="openEditPersonalityModal()">Edit Personality</button>
                <button type="button" class="px-6 py-3 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent" onclick="openNewPersonalityModal()">New Personality</button>
                <button type="button"
                        class="px-6 py-3 bg-surface-elevated rounded font-medium"
                        :class="selected === 'assistant' ? 'text-foreground-secondary cursor-not-allowed opacity-50' : 'text-foreground cursor-pointer hover:bg-danger hover:text-foreground-on-accent'"
                        :disabled="selected === 'assistant'"
                        :title="selected === 'assistant' ? 'Cannot delete the default Assistant personality' : 'Delete Personality'"
                        @click="selected !== 'assistant' && openDeletePersonalityModal()">Delete Personality</button>
            </div>
        </div>
    </form>

    <script>
        window.personalityRawContent = "{{ personality_preview|escapejs }}";
    </script>

    {% if personality_preview %}
    <div class="bg-surface-secondary p-5 rounded-lg leading-relaxed border-l-4 border-accent mt-5 prose prose-invert max-w-none">
        {{ personality_preview|markdown }}
    </div>
    {% endif %}

    {% endif %}
</div>

<!-- Out-of-band swap: Update New Chat button in sidebar -->
<div id="new-chat-button" hx-swap-oob="true">
{% include "chat/new_chat_button.html" %}
</div>
