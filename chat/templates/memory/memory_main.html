{% load markdown_extras %}
<!-- Header -->
<header class="bg-surface-secondary px-5 py-4 border-b border-border">
    <h1 class="text-2xl text-accent-cyan">User Memory</h1>
    <div class="text-xs text-foreground-secondary mt-1">Model: {{ model }}</div>
</header>

<!-- Memory Content -->
<div class="flex-1 overflow-y-auto p-5">
    {% if error %}
    <div class="p-3 px-4 rounded mb-4 bg-danger text-white flex items-center gap-2">{% include 'icons/alert.html' with class='w-5 h-5' %} {{ error }}</div>
    {% endif %}

    <div class="flex gap-3 my-5">
        <form hx-post="{% url 'update_memory' %}"
              hx-target="#main-content"
              hx-swap="innerHTML"
              hx-on::before-request="showMemoryUpdating()">
            {% csrf_token %}
            <button type="submit" class="px-6 py-3 bg-accent text-white rounded font-medium cursor-pointer hover:bg-accent-hover" id="update-memory-btn">Update User Memory</button>
        </form>

        <button onclick="openContextFilesModal()" class="group context-files-btn px-6 py-3 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent">
            Context Files{% if context_files %}<span class="badge bg-accent text-white rounded-xl px-2 py-0.5 text-xs ml-2 group-hover:bg-foreground-on-accent group-hover:text-accent">{{ context_files|length }}</span>{% endif %}
        </button>

        <button onclick="openWipeMemoryModal()" class="px-6 py-3 bg-surface-elevated text-foreground rounded font-medium cursor-pointer hover:bg-danger hover:text-foreground-on-accent">Wipe Memory</button>
    </div>

    <div class="text-xs text-foreground-secondary mb-4">
        {% if last_update %}Last updated: <span id="last-update-time" data-timestamp="{{ last_update|date:'U' }}"></span>{% else %}Never updated from all sessions{% endif %}<span id="memory-status" {% if not just_updated %}style="display: none;"{% endif %}> Â· {% if just_updated %}{% include 'icons/check-circle.html' with class='w-4 h-4 inline' %} {{ success }}{% else %}Updating memory from all sessions<span class="updating-dots"><span class="animate-blink">.</span><span class="animate-blink" style="animation-delay: 0.2s;">.</span><span class="animate-blink" style="animation-delay: 0.4s;">.</span></span>{% endif %}</span>
    </div>
    <script>
        (function() {
            const el = document.getElementById('last-update-time');
            if (el && el.dataset.timestamp) {
                const date = new Date(parseInt(el.dataset.timestamp) * 1000);
                el.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' at ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }
        })();
    </script>

    <div class="bg-surface-secondary p-5 rounded-lg leading-relaxed border-l-4 border-accent">
        {% if memory_content %}
        <div class="prose prose-invert max-w-none">{{ memory_content|markdown }}</div>
        {% else %}
            <div class="text-center text-foreground-secondary py-10 px-5">
                <strong>No long-term memory found yet.</strong><br>
                Memory will be created after your first update.
            </div>
        {% endif %}
    </div>

    <!-- Memory Modification Input -->
    <div class="bg-surface-secondary p-5 border-t border-border mt-5">
        <form hx-post="{% url 'modify_memory' %}"
              hx-target="#main-content"
              hx-swap="innerHTML"
              hx-on::before-request="showMemoryModifying(event)"
              class="flex gap-3 items-end">
            {% csrf_token %}
            <input type="text"
                   name="command"
                   id="memory-command-input"
                   placeholder="Update your memory..."
                   required
                   autocomplete="off"
                   class="flex-1 p-3 border border-border rounded bg-surface text-foreground text-base focus:outline-none focus:border-accent-cyan">
            <button type="submit" class="px-6 py-3 bg-accent text-white border border-accent rounded cursor-pointer font-medium text-base hover:bg-accent-hover">Update</button>
        </form>
    </div>

    <!-- Pass context files data to Alpine.js -->
    <script>
        window.contextFilesData = [
            {% for file in context_files %}
            { name: "{{ file.name }}", enabled: {{ file.enabled|yesno:"true,false" }} }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
    </script>
</div>
