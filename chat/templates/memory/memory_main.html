{% load markdown_extras %}
<!-- Header -->
<header class="bg-surface-secondary px-5 py-4 border-b border-border">
    <h1 class="text-2xl text-accent-cyan">User Memory</h1>
    <div class="text-xs text-foreground-secondary mt-1">Model: {{ model }}</div>
</header>

<!-- Memory Content -->
<div class="flex-1 overflow-y-auto p-5">
    {% if error %}
    <div class="p-3 px-4 rounded mb-4 bg-danger text-white flex items-center gap-2">{% include 'icons/alert.html' with class='w-5 h-5' %} {{ error }}</div>
    {% endif %}

    <div class="flex flex-col md:flex-row gap-3 my-5">
        <form hx-post="{% url 'update_memory' %}"
              hx-target="#main-content"
              hx-swap="innerHTML"
              hx-on::before-request="showMemoryUpdating()"
              class="w-full md:w-auto">
            {% csrf_token %}
            <button type="submit" class="w-full md:w-auto px-6 py-3 bg-accent text-foreground-on-accent rounded font-medium cursor-pointer hover:bg-accent-hover" id="update-memory-btn">Update User Memory</button>
        </form>

        <button onclick="openContextFilesModal()" class="w-full md:w-auto group context-files-btn px-6 py-3 bg-border text-foreground rounded font-medium cursor-pointer hover:bg-accent hover:text-foreground-on-accent">
            Context Files{% if context_files %}<span class="badge bg-accent text-foreground-on-accent rounded-xl px-2 py-0.5 text-xs ml-2 group-hover:bg-foreground-on-accent group-hover:text-accent">{{ context_files|length }}</span>{% endif %}
        </button>

        <button onclick="openWipeMemoryModal()" class="w-full md:w-auto px-6 py-3 bg-border text-foreground rounded font-medium cursor-pointer hover:bg-danger hover:text-foreground-on-accent">Wipe Memory</button>
    </div>

    <!-- Memory Generation Settings -->
    <h2 class="text-accent-cyan text-xl mb-4">Memory Generation Limits</h2>
    <div class="mb-5"
         x-data="{
             userHistoryMaxThreads: {{ user_history_max_threads }},
             userHistoryMessagesPerThread: {{ user_history_messages_per_thread }},
             saved: true,
             saving: false,
             async save() {
                 this.saving = true;
                 const form = new FormData();
                 form.append('user_history_max_threads', this.userHistoryMaxThreads);
                 form.append('user_history_messages_per_thread', this.userHistoryMessagesPerThread);
                 form.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                 const resp = await fetch('{% url "save_memory_settings" %}', { method: 'POST', body: form });
                 if (resp.ok) { this.saved = true; }
                 this.saving = false;
             }
         }">
        <div class="flex flex-wrap gap-4 items-end">
            <div>
                <label class="block text-xs text-foreground-secondary mb-1">Recent Threads</label>
                <input type="number" x-model="userHistoryMaxThreads" @input="saved = false"
                       min="0" max="100" placeholder="0"
                       class="w-20 p-2 border border-border rounded bg-surface text-foreground text-sm focus:outline-none focus:border-accent-cyan">
            </div>
            <div>
                <label class="block text-xs text-foreground-secondary mb-1">Messages Per Thread</label>
                <input type="number" x-model="userHistoryMessagesPerThread" @input="saved = false"
                       min="0" max="10000" step="100" placeholder="0"
                       class="w-24 p-2 border border-border rounded bg-surface text-foreground text-sm focus:outline-none focus:border-accent-cyan">
            </div>
            <button type="button" @click="save()" x-show="!saved" :disabled="saving"
                    class="px-3 py-2 bg-accent text-foreground-on-accent rounded text-sm font-medium cursor-pointer hover:bg-accent-hover">
                <span x-show="!saving">Save</span>
                <span x-show="saving">...</span>
            </button>
        </div>
        <p class="text-xs text-foreground-muted mt-2">Set to 0 for unlimited. Limits help reduce token usage when generating memory.</p>
    </div>

    <div class="text-xs text-foreground-secondary mb-4">
        {% if last_update %}Last updated: <span id="last-update-time" data-timestamp="{{ last_update|date:'U' }}"></span>{% else %}Never updated from all sessions{% endif %}<span id="memory-status" {% if not just_updated %}style="display: none;"{% endif %}> Â· {% if just_updated %}{% include 'icons/check-circle.html' with class='w-4 h-4 inline' %} {{ success }}{% else %}Updating memory from all sessions<span class="updating-dots"><span class="animate-blink">.</span><span class="animate-blink" style="animation-delay: 0.2s;">.</span><span class="animate-blink" style="animation-delay: 0.4s;">.</span></span>{% endif %}</span>
    </div>
    <script>
        (function() {
            const el = document.getElementById('last-update-time');
            if (el && el.dataset.timestamp) {
                const date = new Date(parseInt(el.dataset.timestamp) * 1000);
                el.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' at ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }
        })();
    </script>

    <div class="bg-surface-secondary p-5 rounded-lg leading-relaxed border-l-4 border-accent">
        {% if memory_content %}
        <div class="prose prose-invert max-w-none !text-foreground-secondary prose-headings:!text-foreground-secondary">{{ memory_content|markdown }}</div>
        {% else %}
            <div class="text-center text-foreground-secondary py-10 px-5">
                <strong>No long-term memory found yet.</strong><br>
                Memory will be created after your first update.
            </div>
        {% endif %}
    </div>

    <!-- Memory Modification Input -->
    <div class="bg-surface-secondary p-5 border-t border-border mt-5">
        <form hx-post="{% url 'modify_memory' %}"
              hx-target="#main-content"
              hx-swap="innerHTML"
              hx-on::before-request="showMemoryModifying(event)"
              class="flex gap-3 items-end">
            {% csrf_token %}
            <input type="text"
                   name="command"
                   id="memory-command-input"
                   placeholder="Update your memory..."
                   required
                   autocomplete="off"
                   class="flex-1 p-3 border border-border rounded bg-surface text-foreground text-base focus:outline-none focus:border-accent-cyan">
            <button type="submit" class="px-6 py-3 bg-accent text-foreground-on-accent border border-accent rounded cursor-pointer font-medium text-base hover:bg-accent-hover">Update</button>
        </form>
    </div>

    <!-- Pass context files data to Alpine.js -->
    <script>
        window.contextFilesData = [
            {% for file in context_files %}
            { name: "{{ file.name }}", enabled: {{ file.enabled|yesno:"true,false" }} }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
    </script>
</div>
